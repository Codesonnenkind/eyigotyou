<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EYIGOTYOU</title>
    <link rel="icon" type="image/jpeg" href="https://www.dropbox.com/scl/fi/n2ez50rho6xydpma93sq2/500.jpeg?rlkey=8omntfna9sqvagk8p6cs7gjwh&raw=1" onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>E</text></svg>'">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-color: #0A0A0A;
            --primary-color: #FFFFFF;
            --secondary-color: #888888;
            --accent-color: #1E8449;
            --warning-color: #EF4444;
            --camelot-highlight-strong: #1E8449;
            --camelot-highlight-soft: rgba(30, 132, 73, 0.7);
            --camelot-sequence-step1: rgba(30, 132, 73, 0.7);
            --camelot-sequence-step2: rgba(30, 132, 73, 0.4);
            --camelot-switch-key-color: #454545;
            --carbs-color: #ffca3a;   
            --protein-color: #8ac926; 
            --fats-color: #ff595e;
            --water-color: #1982c4;
        }

        html, body {
            height: 100%;
            margin: 0;
            background-color: var(--background-color);
            color: var(--secondary-color);
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            overflow: hidden; 
            overflow-x: hidden; 
        }

        #app-wrapper {
             display: flex;
             flex-direction: column;
             align-items: center;
             width: 100%;
             height: 100%;
             max-height: 100%;
             overflow-y: hidden;
             box-sizing: border-box;
        }

        #app-wrapper.is-panel-open {
            overflow-y: auto;
        }
        
        /* --- Corner Icons --- */
        .site-logo {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 45px;
            height: auto;
            z-index: 100;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .site-logo:hover {
            transform: scale(1.1);
        }
        
        .site-icon-left {
            position: fixed;
            width: 32px;
            height: auto;
            z-index: 100;
            filter: invert(1) opacity(0.6);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        
        .site-icon-left:hover {
            transform: scale(1.1);
            filter: invert(1) opacity(1);
        }
        
        #menu-icon { top: 15px; left: 15px; z-index: 101; }
        
        /* Horizontal utility icons */
        #bell-icon { top: 15px; left: 60px; }
        #notepad-icon { top: 15px; left: 105px; width: 38px; }
        #food-timer-icon { top: 15px; left: 155px; }

        /* Vertical creative tool icons */
        #metronome-icon { top: 65px; left: 15px; }
        #color-checker-icon { top: 115px; left: 15px; }
        #color-picker-icon { top: 165px; left: 15px; }


        #left-icon-menu .site-icon-left:not(#menu-icon) {
            opacity: 0;
            visibility: hidden;
            transform: translateX(-20px);
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
        }
        #left-icon-menu.menu-open .site-icon-left:not(#menu-icon) {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }
        
        /* Transition delays for all animated icons */
        #left-icon-menu .site-icon-left:nth-child(2) { transition-delay: 0.05s; }
        #left-icon-menu .site-icon-left:nth-child(3) { transition-delay: 0.1s; }
        #left-icon-menu .site-icon-left:nth-child(4) { transition-delay: 0.15s; }
        #left-icon-menu .site-icon-left:nth-child(5) { transition-delay: 0.2s; }
        #left-icon-menu .site-icon-left:nth-child(6) { transition-delay: 0.25s; }
        #left-icon-menu .site-icon-left:nth-child(7) { transition-delay: 0.3s; }
        

        /* --- Layout Structure --- */
        .sticky-wrapper {
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: var(--background-color);
            padding-top: 5vh; 
            padding-bottom: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .scrollable-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            padding: 0 20px 20px 20px;
            box-sizing: border-box;
        }

        .module-controls {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .module-controls.active {
            display: flex;
        }

        .sticky-display {
            display: none;
            height: 100%;
            width: 100%;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .sticky-display.active {
            display: flex;
        }
        
        /* --- Donate Overlay --- */
        #donate-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(10, 10, 10, 0.95);
            z-index: 200;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #donate-overlay.active {
            display: flex;
            opacity: 1;
        }
        #donate-content {
            color: var(--primary-color);
            max-width: 420px;
            width: 100%;
            text-align: left;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        #donate-intro-text p {
            margin: 0 0 1em 0;
            color: var(--secondary-color);
            min-height: 1.6em; /* Reserve space to prevent layout shift */
        }
        .typing-cursor {
            border-right: .15em solid var(--accent-color);
            animation: blink-caret .75s step-end infinite;
        }
        @keyframes blink-caret {
          from, to { border-color: transparent }
          50% { border-color: var(--accent-color); }
        }

        #kofi-container {
            border: 2px solid #2a2a2a;
            padding: 4px;
            background: #121212;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }

        #close-donate-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2rem;
            color: var(--secondary-color);
            background: none;
            border: none;
            cursor: pointer;
            line-height: 1;
        }
        #close-donate-btn:hover {
            color: var(--primary-color);
        }


        /* --- Timer Specific --- */
        .timer-container {
            position: relative;
            width: 65vw; 
            height: 65vw;
            max-width: 240px; 
            max-height: 240px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: default;
        }

        .timer-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .timer-circle {
            fill: none;
            stroke-width: 4; 
        }
        
        #timer-track { stroke: var(--secondary-color); opacity: 0.1; }

        #timer-progress {
            stroke: var(--primary-color);
            stroke-linecap: round;
            transition: stroke 0.5s ease-in-out, stroke-dashoffset 0.2s linear;
        }
        
        #progress-dot {
            fill: var(--primary-color);
            transition: fill 0.5s ease-in-out;
            animation: pulsate 1.5s infinite alternate ease-in-out;
        }

        @keyframes pulsate {
            from { r: 1; }
            to { r: 3; }
        }

        #time-left {
            z-index: 1; 
            font-size: clamp(2rem, 10vw, 3rem); 
            font-weight: 700;
            letter-spacing: 0.1em;
            color: var(--primary-color);
        }
        
        #mode-display, #calc-view-title, #camelot-view-title, #color-checker-title, #metronome-view-title, #food-timer-title, #notepad-title, #color-picker-title {
            z-index: 2;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: var(--secondary-color);
            transition: color 0.5s ease-in-out;
            text-align: center;
            height: 1em; /* Reserve space */
            margin-bottom: 15px; /* Increased margin */
        }
        
        #timer-controls #mode-display {
            cursor: pointer;
        }

        /* --- Metronome Specific --- */
        .metronome-display {
            width: 65vw; 
            height: 65vw;
            max-width: 240px;
            max-height: 240px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            border: 12px solid rgba(136, 136, 136, 0.1);
            border-radius: 50%;
            transition: border-color 0.1s ease, background-color 0.1s ease, transform 0.1s ease-out;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            box-sizing: border-box;
        }

        #bpm-display {
            font-size: clamp(2.5rem, 11vw, 3.5rem); 
            font-weight: 700;
            color: var(--primary-color);
        }
        #bpm-label {
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: var(--secondary-color);
        }
        
        /* --- Snack Time Specific --- */
        #pie-chart-container {
            position: relative;
            width: 65vw; 
            height: 65vw;
            max-width: 240px; 
            max-height: 240px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column; 
        }
        #pie-chart-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }
        #pie-chart-svg .water-ring, #pie-chart-svg .macro-ring-slice {
             transform-origin: center;
             transform: rotate(-90deg);
             transition: stroke-dashoffset 0.5s ease-in-out, transform 0.5s ease-in-out;
        }

        #food-percentages-display {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            z-index: 3;
            text-shadow: 0 0 5px rgba(0,0,0,0.7);
        }
        .macro-percentage-row {
            display: flex;
            gap: 10px;
        }
        .macro-percentage {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            font-weight: 700;
        }
        #food-legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px 15px;
            width: 100%;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        .legend-color-swatch {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        #food-video-container {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 68%;
            height: 68%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            overflow: hidden;
            z-index: 1;
        }
        #food-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        @keyframes pulsate-bright {
          0%, 100% { color: var(--secondary-color); }
          50% { color: var(--primary-color); }
        }
        .pulsating-title {
          animation: pulsate-bright 1s ease-in-out;
        }
        
        #notepad-panel {
            width: 100%;
            max-width: 300px;
        }
        #notepad-panel .control-panel {
            max-width: 100%;
        }
        #notepad-textarea {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 2px solid var(--secondary-color);
            color: var(--primary-color);
            border-radius: 0;
            padding: 8px;
            font-family: 'Inter', sans-serif;
            resize: vertical;
            min-height: 120px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        #notepad-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* --- Generic Controls --- */
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 240px;
        }

        .control-group {
            display: flex;
            border: 2px solid var(--secondary-color);
            overflow: hidden;
        }
        
        .control-btn, .mode-btn, .setting-item {
            background-color: transparent;
            border: none;
            color: var(--secondary-color);
            padding: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center; 
            gap: 8px;
            cursor: pointer;
            flex: 1;
        }
        
        .control-group > *:not(:last-child) {
             border-right: 2px solid var(--secondary-color);
        }

        .mode-btn.active {
            background-color: var(--secondary-color);
            color: var(--background-color);
        }
        
        .control-btn:hover, .mode-btn:not(.active):hover, #reset-metronome:hover {
            color: var(--primary-color);
        }

        .mode-btn[data-mode="pomodoro"], #start-pause-btn, .setting-item.label, #play-stop-metronome { 
            flex-grow: 2;
            justify-content: flex-start;
            padding-left: 15px;
        }
        
        #pomodoro-settings .setting-item.label {
            cursor: pointer;
        }

        .back-button { flex-basis: 100%; justify-content: center; }
        #reset-metronome { flex-grow: 1; flex-basis: 0; }
        #bpm-slider-container { flex-grow: 1; padding: 0 8px; }
        
        #settings-container { position: relative; height: 125px; }
        
        .options-wrapper {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-height: 180px;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, gap 0.5s ease-in-out;
        }

        .options-wrapper.hidden {
            max-height: 0;
            gap: 0;
        }


        .settings-panel {
            position: absolute; top: 0; left: 0; width: 100%;
            display: flex; flex-direction: column; gap: 10px;
            opacity: 0; visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
        }
        .settings-panel.active { opacity: 1; visibility: visible; }
        .setting-item.label span { font-size: 0.7rem; font-weight: 400; opacity: 0.7; margin-left: 5px; }
        .settings-panel input[type="number"] {
            background-color: transparent; border: none; color: var(--primary-color);
            padding: 0; width: 40px; text-align: center;
            font-family: inherit; font-size: 0.8rem; font-weight: 500; outline: none;
        }
        input[type=number] { -moz-appearance: textfield; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        #bpm-slider {
            -webkit-appearance: none; appearance: none; width: 100%; height: 8px;
            background: var(--secondary-color); outline: none; opacity: 0.7;
            transition: opacity .2s; border-radius: 4px;
        }
        #bpm-slider:hover { opacity: 1; }
        #bpm-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
            background: var(--primary-color); cursor: pointer; border-radius: 50%;
        }
        #bpm-slider::-moz-range-thumb {
            width: 20px; height: 20px; background: var(--primary-color);
            cursor: pointer; border-radius: 50%; border: none;
        }

        .collapsible-panel {
            width: 100%; max-width: 300px;
            margin-top: 15px; max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, margin-top 0.5s ease-in-out;
        }
        .collapsible-panel.visible { max-height: 1000px; }
        .calc-header-container {
            display: flex; border: 2px solid var(--secondary-color);
            overflow: hidden; margin-bottom: -2px;
        }
        .calc-header {
            flex: 1; padding: 8px; text-align: center; font-size: 0.8rem;
            font-weight: 600; text-transform: uppercase;
        }
        #calc-reverb-header { background-color: var(--secondary-color); color: var(--background-color); }
        .calc-table {
            width: 100%; border-collapse: collapse; font-size: 0.7rem;
            color: var(--secondary-color); margin-bottom: 10px;
        }
        .calc-table th, .calc-table td {
            border: 2px solid var(--secondary-color); padding: 4px; 
            text-align: center; font-weight: 500; font-size: 0.65rem;
        }
        #reverb-table thead { background-color: var(--secondary-color); }
        #reverb-table thead th { color: var(--background-color); }
        .calc-table td:first-child {
            font-weight: 600; color: var(--primary-color); text-align: left; padding-left: 8px;
        }
        #delay-table { border-collapse: collapse; margin-top: 15px; }
        #delay-table caption {
            background-color: var(--accent-color); color: var(--background-color);
            padding: 8px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase;
            border: 2px solid var(--accent-color); border-bottom: none;
        }
        #delay-table, #delay-table th, #delay-table td { border: 2px solid var(--accent-color); }
        #delay-table thead th { background-color: var(--accent-color); color: var(--background-color); }
        #delay-table td:first-child {
            font-weight: 700; text-align: left; padding-left: 8px; color: var(--primary-color);
        }

        /* --- Camelot Table Styles --- */
        #camelot-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
        }
        #camelot-table th, #camelot-table td {
            border: 2px solid var(--secondary-color);
            text-align: center;
            padding: 4px 0;
            font-size: 0.8rem;
            font-weight: 600;
        }
        #camelot-table th {
            text-transform: uppercase;
        }
        #camelot-table td {
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .key-cell:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .key-cell.selected {
            background-color: var(--camelot-highlight-strong);
            color: var(--background-color);
        }
        .key-cell.compatible {
            background-color: var(--camelot-highlight-soft);
        }
        .key-cell.sequence-step1 {
            background-color: var(--camelot-sequence-step1);
        }
        .key-cell.sequence-step2 {
            background-color: var(--camelot-sequence-step2);
        }
        .key-cell.switch-key {
            background-color: var(--camelot-switch-key-color);
        }

        .time-unit {
            font-size: 0.5rem;
            color: var(--secondary-color);
            opacity: 0.8;
            margin-left: 2px;
        }
        
        /* --- Color Checker Styles --- */
        #color-checker-container {
            width: 100%;
            max-width: 240px; 
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #color-checker-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            width: 100%;
            border: 2px solid var(--secondary-color);
            padding: 5px;
            background-color: #333;
            box-sizing: border-box;
        }
        .color-swatch {
            width: 100%;
            padding-bottom: 100%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .color-swatch.selected {
            border-color: white;
            transform: scale(1.05);
            box-shadow: 0 0 10px white;
        }
        #color-info-display {
            display: flex;
            flex-direction: column;
            gap: 4px;
            border: 2px solid var(--secondary-color);
            padding: 8px;
            min-height: 60px;
            font-size: 0.8rem;
            font-weight: 500;
            box-sizing: border-box;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
        }
        .info-label {
            color: var(--secondary-color);
            font-weight: 600;
        }
        .info-value {
            color: var(--primary-color);
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 0.05em;
        }
        .info-value-hex {
            text-transform: uppercase;
        }

        #color-checker-container:fullscreen {
            max-width: none;
            width: 100%;
            height: 100%;
            padding: 5vw;
            background: var(--background-color);
            justify-content: center;
            box-sizing: border-box;
        }
        
        /* --- Color Palette Tool Styles --- */
        #color-palette-tool-wrapper {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 320px; /* Wider for better layout */
        }
        #palette-swatches-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px;
            border: 2px solid var(--secondary-color);
            min-height: 120px;
            width: 100%;
            box-sizing: border-box;
            align-content: flex-start;
        }
        .palette-swatch {
            position: relative;
            width: 50px;
            height: 50px;
            border: 2px solid var(--secondary-color);
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.3s ease;
        }
        .palette-swatch:hover {
            transform: scale(1.05);
            border-color: var(--primary-color);
        }
        .palette-swatch.locked {
            border-color: var(--accent-color);
        }
        .swatch-delete-btn, .swatch-lock-btn {
            position: absolute;
            top: -1px;
            background: var(--background-color);
            border: 1px solid var(--secondary-color);
            color: var(--secondary-color);
            cursor: pointer;
            width: 16px;
            height: 16px;
            font-size: 10px;
            line-height: 14px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .swatch-delete-btn { right: -1px; }
        .swatch-lock-btn { left: -1px; }
        .swatch-lock-btn.locked { color: var(--accent-color); }

        .swatch-ratio-input {
            position: absolute;
            bottom: 2px;
            left: 2px;
            width: calc(100% - 4px);
            background: rgba(0,0,0,0.6);
            border: none;
            color: white;
            text-align: center;
            font-size: 10px;
            -moz-appearance: textfield;
            font-family: 'Orbitron', sans-serif;
        }
        input.swatch-ratio-input::-webkit-outer-spin-button,
        input.swatch-ratio-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
       
        #palette-ratio-chart {
            display: flex;
            width: 100%;
            height: 20px;
            border: 2px solid var(--secondary-color);
            box-sizing: border-box;
            overflow: hidden;
        }
        .ratio-bar-segment {
            height: 100%;
            transition: width 0.3s ease-in-out;
        }
        .palette-preset-select {
             background: transparent;
             color: var(--secondary-color);
             border: 2px solid var(--secondary-color);
             padding: 8px;
             width: 100%;
             font-family: inherit;
             font-weight: 600;
        }
        .palette-preset-select:focus { outline: none; border-color: var(--primary-color); }
        
        #palette-contrast-display {
            padding: 8px;
            text-align: center;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            color: var(--secondary-color);
            letter-spacing: 0.1em;
        }
        #palette-contrast-value {
             color: var(--primary-color);
             font-family: 'Orbitron', sans-serif;
             margin-left: 8px;
        }


        .hidden { display: none !important; }
    </style>
</head>
<body>
    
    <div id="app-wrapper">
        <div id="left-icon-menu">
            <img src="https://www.dropbox.com/scl/fi/nsoox7qxngmnv2m051oq6/flower-svgrepo-com.svg?rlkey=m66gvnscbizjt7wopju9ym95t&raw=1" alt="Menu Icon" class="site-icon-left" id="menu-icon">
            <img src="https://www.dropbox.com/scl/fi/1m4jb4opjgtxoy6yz2yf0/bell-svgrepo-com.svg?rlkey=8po6w24uqopz056gd5vwk42o2&raw=1" alt="Bell Icon" class="site-icon-left" id="bell-icon">
            <img src="https://www.dropbox.com/scl/fi/1uvselpcovxwl1ahvdhjz/notes-svgrepo-com.svg?rlkey=eidktq0vfjc2ss4kuw2252hl1&raw=1" alt="Notepad Icon" class="site-icon-left" id="notepad-icon" style="width: 38px;">
            <img src="https://www.dropbox.com/scl/fi/06zb1jshbaq0jexaoglmu/fork-and-knife-combination-svgrepo-com.svg?rlkey=kbojyzwetkn5tz5ls8wnw62b4&raw=1" alt="Food Timer Icon" class="site-icon-left" id="food-timer-icon">
            <img src="https://www.dropbox.com/scl/fi/5b4motyxla5bkgbk1c3d0/metronome-svgrepo-com.svg?rlkey=w161g2mtryo635255gqooha7z&raw=1" alt="Metronome Icon" class="site-icon-left" id="metronome-icon">
            <svg id="color-checker-icon" viewBox="0 0 24 24" class="site-icon-left" xmlns="http://www.w3.org/2000/svg"><path d="M2 2v20h20V2H2zm2 2h4v4H4V4zm6 0h4v4h-4V4zm6 0h4v4h-4V4zm-6 6h4v4h-4v-4zm-6 0h4v4H4v-4zm12 0h4v4h-4v-4zm-6 6h4v4h-4v-4zm-6 0h4v4H4v-4zm12 0h4v4h-4v-4z"/></svg>
            <img src="https://www.dropbox.com/scl/fi/fsnyl0iyxkbo28hcvmiee/pipette-svgrepo-com.svg?rlkey=c3ehuk0e6z7ex6u02fb6t6rbr&raw=1" alt="Color Picker Icon" class="site-icon-left" id="color-picker-icon">
        </div>

        <img src="https://www.dropbox.com/scl/fi/y2i8ul09le7i5v03lehma/500.png?rlkey=rbh2kx5rbcgmgowl49ceb9tpv&raw=1" alt="Logo" class="site-logo" id="main-logo" onerror="this.style.display='none'">
        
        <div id="donate-overlay">
            <div id="donate-content">
                <button id="close-donate-btn">&times;</button>
                <div id="donate-intro-text">
                    <p id="donate-line-1"></p>
                    <p id="donate-line-2"></p>
                </div>
                 <div id="kofi-container">
                    <iframe id='kofiframe' src='https://ko-fi.com/konstantinsonnenkind/?hidefeed=true&widget=true&embed=true&preview=true&theme=dark' style='border:none;width:100%;' height='712' title='konstantinsonnenkind'></iframe>
                </div>
            </div>
        </div>

        <div class="sticky-wrapper">
            <div id="timer-display-sticky" class="sticky-display active">
                <div class="timer-container">
                    <svg class="timer-svg" viewBox="0 0 100 100">
                        <circle class="timer-circle" id="timer-track" cx="50" cy="50" r="45"></circle>
                        <circle class="timer-circle" id="timer-progress" cx="50" cy="50" r="45"></circle>
                        <g transform="rotate(90, 50, 50)">
                            <circle id="progress-dot" cx="50" cy="5" r="2"></circle>
                        </g>
                    </svg>
                    <div id="time-left" role="timer" aria-live="polite">25:00</div>
                </div>
            </div>
            <div id="metronome-display-sticky" class="sticky-display">
                <div id="metronome-tap-area" class="metronome-display">
                    <div id="bpm-display">135</div>
                    <div id="bpm-label">BPM</div>
                </div>
            </div>
            <div id="color-checker-display-sticky" class="sticky-display">
                <div id="color-checker-container">
                    <div id="color-checker-grid"></div>
                    <div id="color-info-display">
                        <div class="info-row"><span class="info-label">Name</span> <span id="color-name-value" class="info-value"></span></div>
                        <div class="info-row"><span class="info-label">HEX</span> <span id="color-hex-value" class="info-value info-value-hex"></span></div>
                        <div class="info-row"><span class="info-label">RGB</span> <span id="color-rgb-value" class="info-value"></span></div>
                    </div>
                </div>
            </div>
            <div id="food-timer-display-sticky" class="sticky-display">
                <div id="pie-chart-container">
                    <div id="food-video-container">
                        <video autoplay muted loop playsinline id="food-video">
                           <source src="https://www.dropbox.com/scl/fi/g3rqov9p9uhu7x4h3vaj2/Burger-Run3.mp4?rlkey=bxyhx0dacori15beosu2h7dmy&raw=1" type="video/mp4">
                        </video>
                    </div>
                    <svg id="pie-chart-svg" viewBox="0 0 100 100">
                        <circle id="water-ring-bg" cx="50" cy="50" r="47" fill="none" stroke="rgba(136, 136, 136, 0.2)" stroke-width="6"></circle>
                        <circle id="water-ring" class="water-ring" cx="50" cy="50" r="47" fill="none" stroke="var(--water-color)" stroke-width="6" stroke-linecap="round"></circle>
                        <g id="pie-chart-slices"></g>
                    </svg>
                    <div id="food-percentages-display"></div>
                </div>
            </div>
            <div id="color-picker-display-sticky" class="sticky-display">
                <div id="color-palette-tool-wrapper">
                    <div id="palette-swatches-container"></div>
                    <div id="palette-ratio-chart"></div>
                    <div id="palette-contrast-display">Contrast: <span id="palette-contrast-value">N/A</span></div>
                </div>
            </div>
        </div>

        <div class="scrollable-content">
            <div id="timer-controls" class="module-controls active">
                <div id="mode-display">Work</div>
                <div class="control-panel">
                    <div id="timer-options-wrapper" class="options-wrapper">
                        <div class="control-group"><button class="mode-btn" data-mode="pomodoro">Pomodoro</button><button class="mode-btn" data-mode="sports">Sports</button></div>
                        <div id="settings-container">
                            <div id="pomodoro-settings" class="settings-panel">
                                <div class="control-group"><div class="setting-item label" data-start-mode="work">WORK <span>(MIN)</span></div><div class="setting-item"><input type="number" id="work-time" value="25" min="1"></div></div>
                                <div class="control-group"><div class="setting-item label" data-start-mode="break">BREAK <span>(MIN)</span></div><div class="setting-item"><input type="number" id="break-time" value="5" min="1"></div></div>
                            </div>
                            <div id="sports-settings" class="settings-panel">
                                <div class="control-group"><div class="setting-item label">Workout <span>(SEC)</span></div><div class="setting-item"><input type="number" id="workout-time" value="45" min="0"></div></div>
                                <div class="control-group"><div class="setting-item label">Rest <span>(SEC)</span></div><div class="setting-item"><input type="number" id="rest-time" value="15" min="0"></div></div>
                                <div class="control-group"><div class="setting-item label">Rounds</div><div class="setting-item"><input type="number" id="rounds" value="8" min="1"></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="control-group"><button class="control-btn" id="start-pause-btn">Start</button><button class="control-btn" id="reset-btn">Reset</button></div>
                </div>
            </div>
            <div id="metronome-controls" class="module-controls">
                <div id="metronome-view-title">Metronome</div>
                <div class="control-panel">
                    <div class="control-group">
                        <button class="control-btn" id="play-stop-metronome">Play</button>
                        <button class="control-btn" id="reset-metronome">Reset</button>
                    </div>
                    <div id="metronome-options-wrapper" class="options-wrapper">
                        <div class="control-group">
                            <div class="setting-item" id="bpm-slider-container">
                                <input type="range" min="40" max="220" value="135" id="bpm-slider">
                            </div>
                        </div>
                    </div>
                    <div class="control-group"><button class="control-btn back-button" id="back-to-timer-from-metro">Back to Timer</button></div>
                </div>
            </div>
            
            <div id="color-checker-controls" class="module-controls">
                 <div id="color-checker-title">Color Checker</div>
                 <div class="control-panel">
                    <div class="control-group"><button class="control-btn" id="fullscreen-btn">Fullscreen</button></div>
                    <div class="control-group"><button class="control-btn back-button" id="back-to-timer-from-checker">Back to Timer</button></div>
                 </div>
            </div>

            <div id="food-timer-controls" class="module-controls">
                <div id="food-timer-title">SNACK TIME</div>
                <div class="control-panel">
                    <div class="control-group">
                        <button class="control-btn" id="generate-meal-btn">Generate Meal</button>
                        <button class="control-btn" id="generate-snack-btn">Generate Snack</button>
                    </div>
                    <div id="food-legend">
                        <div class="legend-item"><div class="legend-color-swatch" style="background-color: var(--water-color);"></div>Water</div>
                        <div class="legend-item"><div class="legend-color-swatch" style="background-color: var(--carbs-color);"></div>Carbs</div>
                        <div class="legend-item"><div class="legend-color-swatch" style="background-color: var(--protein-color);"></div>Protein</div>
                        <div class="legend-item"><div class="legend-color-swatch" style="background-color: var(--fats-color);"></div>Fats</div>
                    </div>
                    <div class="control-group"><button class="control-btn back-button" id="back-to-timer-from-food">Back to Timer</button></div>
                </div>
            </div>

            <div id="color-picker-controls" class="module-controls">
                 <div id="color-picker-title">Color Palette Tool</div>
                 <div class="control-panel" style="max-width: 320px;">
                    <div class="control-group"><button class="control-btn" id="eyedropper-btn">Pick Color</button></div>
                    <select class="palette-preset-select" id="palette-ratio-preset-select">
                        <option value="">Apply Ratio Preset...</option>
                        <optgroup label="Film Ratios">
                            <option value="bladeRunnerRatios">Blade Runner</option>
                            <option value="herRatios">Her</option>
                            <option value="madMaxRatios">Mad Max: Fury Road</option>
                            <option value="jokerRatios">Joker</option>
                        </optgroup>
                        <optgroup label="Graphic Design Ratios">
                            <option value="sixtyThirtyTen">60/30/10</option>
                            <option value="complementary">Complementary</option>
                            <option value="triadic">Triadic (Equal)</option>
                            <option value="analogous">Analogous</option>
                        </optgroup>
                    </select>
                    <div class="control-group">
                        <button class="control-btn" id="palette-random-contrast-btn">Random Contrast</button>
                        <button class="control-btn" id="palette-randomize-btn">Randomize Ratio</button>
                    </div>
                     <div class="control-group">
                        <button class="control-btn" id="palette-copy-all-btn">Copy All</button>
                        <button class="control-btn" id="palette-clear-btn">Clear</button>
                    </div>
                     <div class="control-group">
                        <button class="control-btn" id="palette-export-btn">Export</button>
                    </div>
                    <div class="control-group"><button class="control-btn back-button" id="back-to-timer-from-picker">Back to Timer</button></div>
                 </div>
            </div>
            
            <div id="notepad-panel" class="collapsible-panel">
                <div id="notepad-title">Notepad</div>
                 <div class="control-panel" style="max-width: 100%;">
                    <textarea id="notepad-textarea" placeholder="Add and save your notes here..."></textarea>
                    <div class="control-group">
                        <button class="control-btn" id="copy-notes-btn">Copy</button>
                        <button class="control-btn" id="clear-notes-btn">Clear</button>
                    </div>
                </div>
            </div>
            
            <div id="camelot-panel" class="collapsible-panel">
                <div id="camelot-view-title">Harmonic Mixing</div>
                <div class="control-panel" style="margin-bottom: 10px; max-width: 300px;">
                    <div class="control-group">
                        <button class="mode-btn camelot-mode-btn active" data-mode="key">Key</button>
                        <button class="mode-btn camelot-mode-btn" data-mode="sequence">Sequence</button>
                    </div>
                </div>
                <table id="camelot-table">
                    <thead>
                        <tr>
                            <th>Minor</th>
                            <th>Major</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="control-panel" style="margin-top: 10px;">
                <div class="control-group">
                    <button class="control-btn" id="open-camelot-btn">Camelot</button>
                </div>
            </div>

            <div id="calc-panel" class="collapsible-panel">
                <div id="calc-view-title">CALCULATOR (<span id="delay-bpm-display">135</span> BPM)</div>
                <table id="delay-table" class="calc-table">
                    <caption>DELAY</caption>
                    <thead><tr><th>NOTE</th><th>NORMAL</th><th>DOTTED</th><th>TRIPLET</th></tr></thead>
                    <tbody>
                        <tr><td>1/1</td><td id="t-1-1"></td><td id="t-1-1-d"></td><td id="t-1-1-t"></td></tr>
                        <tr><td>1/2</td><td id="t-1-2"></td><td id="t-1-2-d"></td><td id="t-1-2-t"></td></tr>
                        <tr><td>1/4</td><td id="t-1-4"></td><td id="t-1-4-d"></td><td id="t-1-4-t"></td></tr>
                        <tr><td>1/8</td><td id="t-1-8"></td><td id="t-1-8-d"></td><td id="t-1-8-t"></td></tr>
                        <tr><td>1/16</td><td id="t-1-16"></td><td id="t-1-16-d"></td><td id="t-1-16-t"></td></tr>
                        <tr><td>1/32</td><td id="t-1-32"></td><td id="t-1-32-d"></td><td id="t-1-32-t"></td></tr>
                    </tbody>
                </table>
                 <div class="calc-header-container" style="margin-top:10px; width: 100%;">
                    <div class="calc-header" id="calc-reverb-header">REVERB</div>
                </div>
                <table id="reverb-table" class="calc-table" style="margin-top: -2px;">
                    <thead><tr><th>SIZE</th><th>PREDELAY</th><th>DECAY</th><th>TOTAL</th></tr></thead>
                    <tbody>
                        <tr><td>Hall</td><td id="r-hall-pre"></td><td id="r-hall-decay"></td><td id="r-hall-total"></td></tr>
                        <tr><td>L Room</td><td id="r-lroom-pre"></td><td id="r-lroom-decay"></td><td id="r-lroom-total"></td></tr>
                        <tr><td>S Room</td><td id="r-sroom-pre"></td><td id="r-sroom-decay"></td><td id="r-sroom-total"></td></tr>
                        <tr><td>Ambience</td><td id="r-ambi-pre"></td><td id="r-ambi-decay"></td><td id="r-ambi-total"></td></tr>
                    </tbody>
                </table>
            </div>
            <div class="control-panel" id="global-calc-btn">
                <div class="control-group">
                    <button class="control-btn" id="open-calc-btn">Calculators</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const UIElements = {
            appWrapper: document.getElementById('app-wrapper'),
            timerDisplaySticky: document.getElementById('timer-display-sticky'),
            metronomeDisplaySticky: document.getElementById('metronome-display-sticky'),
            colorCheckerDisplaySticky: document.getElementById('color-checker-display-sticky'),
            foodTimerDisplaySticky: document.getElementById('food-timer-display-sticky'),
            colorPickerDisplaySticky: document.getElementById('color-picker-display-sticky'),
            timerControls: document.getElementById('timer-controls'),
            metronomeControls: document.getElementById('metronome-controls'),
            colorCheckerControls: document.getElementById('color-checker-controls'),
            foodTimerControls: document.getElementById('food-timer-controls'),
            colorPickerControls: document.getElementById('color-picker-controls'),
            leftIconMenu: document.getElementById('left-icon-menu'),
            menuIcon: document.getElementById('menu-icon'),
            metronomeIcon: document.getElementById('metronome-icon'),
            bellIcon: document.getElementById('bell-icon'),
            colorCheckerIcon: document.getElementById('color-checker-icon'),
            foodTimerIcon: document.getElementById('food-timer-icon'),
            notepadIcon: document.getElementById('notepad-icon'),
            colorPickerIcon: document.getElementById('color-picker-icon'),
            mainLogo: document.getElementById('main-logo'),
            donateOverlay: document.getElementById('donate-overlay'),
            closeDonateBtn: document.getElementById('close-donate-btn'),
            donateLine1: document.getElementById('donate-line-1'),
            donateLine2: document.getElementById('donate-line-2'),
            timeLeftDisplay: document.getElementById('time-left'),
            startPauseBtn: document.getElementById('start-pause-btn'),
            resetBtn: document.getElementById('reset-btn'),
            progressCircle: document.getElementById('timer-progress'),
            progressDot: document.getElementById('progress-dot'),
            modeDisplay: document.getElementById('mode-display'),
            modeBtns: document.querySelectorAll('#timer-controls .mode-btn'),
            pomodoroSettings: document.getElementById('pomodoro-settings'),
            sportsSettings: document.getElementById('sports-settings'),
            allTimerInputs: document.querySelectorAll('#timer-controls .settings-panel input'),
            timerOptionsWrapper: document.getElementById('timer-options-wrapper'), 
            metronomeOptionsWrapper: document.getElementById('metronome-options-wrapper'),
            bpmDisplay: document.getElementById('bpm-display'),
            bpmSlider: document.getElementById('bpm-slider'),
            playStopMetronomeBtn: document.getElementById('play-stop-metronome'),
            visualBeatIndicator: document.getElementById('metronome-tap-area'),
            resetMetronomeBtn: document.getElementById('reset-metronome'),
            backToTimerBtn: document.getElementById('back-to-timer-from-metro'),
            backToTimerFromChecker: document.getElementById('back-to-timer-from-checker'),
            backToTimerFromFood: document.getElementById('back-to-timer-from-food'),
            backToTimerFromPicker: document.getElementById('back-to-timer-from-picker'),
            openCalcBtn: document.getElementById('open-calc-btn'),
            calcPanel: document.getElementById('calc-panel'),
            delayBpmDisplay: document.getElementById('delay-bpm-display'),
            openCamelotBtn: document.getElementById('open-camelot-btn'),
            camelotPanel: document.getElementById('camelot-panel'),
            camelotTableBody: document.querySelector('#camelot-table tbody'),
            camelotViewTitle: document.getElementById('camelot-view-title'),
            camelotModeBtns: document.querySelectorAll('.camelot-mode-btn'),
            colorCheckerGrid: document.getElementById('color-checker-grid'),
            colorNameValue: document.getElementById('color-name-value'),
            colorHexValue: document.getElementById('color-hex-value'),
            colorRgbValue: document.getElementById('color-rgb-value'),
            colorCheckerTitle: document.getElementById('color-checker-title'),
            fullscreenBtn: document.getElementById('fullscreen-btn'),
            // Snack Time elements
            foodTimerTitle: document.getElementById('food-timer-title'),
            pieChartSlices: document.getElementById('pie-chart-slices'),
            waterRing: document.getElementById('water-ring'),
            foodPercentagesDisplay: document.getElementById('food-percentages-display'),
            generateMealBtn: document.getElementById('generate-meal-btn'),
            generateSnackBtn: document.getElementById('generate-snack-btn'),
            // Notepad elements
            notepadPanel: document.getElementById('notepad-panel'),
            notepadTextarea: document.getElementById('notepad-textarea'),
            copyNotesBtn: document.getElementById('copy-notes-btn'),
            clearNotesBtn: document.getElementById('clear-notes-btn'),
            // Color Palette Tool elements
            eyedropperBtn: document.getElementById('eyedropper-btn'),
            paletteSwatchesContainer: document.getElementById('palette-swatches-container'),
            paletteRatioChart: document.getElementById('palette-ratio-chart'),
            paletteContrastValue: document.getElementById('palette-contrast-value'),
            paletteRandomContrastBtn: document.getElementById('palette-random-contrast-btn'),
            paletteCopyAllBtn: document.getElementById('palette-copy-all-btn'),
            paletteClearBtn: document.getElementById('palette-clear-btn'),
            paletteExportBtn: document.getElementById('palette-export-btn'),
            paletteRatioPresetSelect: document.getElementById('palette-ratio-preset-select'),
            paletteRandomizeBtn: document.getElementById('palette-randomize-btn'),
        };

        const AppState = {
            mainTimerId: null, isPaused: true, hasStarted: false, 
            currentAppMode: 'timer', currentTimerMode: 'pomodoro',
            targetTime: null, pomodoro: {}, sports: {},
            audioContext: null, bpm: 135, isMetronomePlaying: false,
            schedulerTimerID: null, beatNumber: 1, beatsPerMeasure: 4,
            tapTimestamps: [], tapTimeoutId: null, isSoundEnabled: true,
            pomodoroInitialState: 'work',
            bellEnabledSrc: "https://www.dropbox.com/scl/fi/1m4jb4opjgtxoy6yz2yf0/bell-svgrepo-com.svg?rlkey=8po6w24uqopz056gd5vwk42o2&raw=1",
            bellDisabledSrc: "https://www.dropbox.com/scl/fi/syg6jjwvngtxl1mwk0hdv/bell-disabled-svgrepo-com.svg?rlkey=lrawxg597knm9h8jifkw21ngj&raw=1",
            palette: {
                lastUsedRatios: []
            },
            typewriterTimeout: null,
        };

        const radius = UIElements.progressCircle.r.baseVal.value;
        const circumference = 2 * Math.PI * radius;
        UIElements.progressCircle.style.strokeDasharray = circumference;

        const Storage = {
            save: (key, value) => localStorage.setItem(`eyigotyou_${key}`, JSON.stringify(value)),
            get: (key, defaultValue) => {
                const storedValue = localStorage.getItem(`eyigotyou_${key}`);
                return storedValue ? JSON.parse(storedValue) : defaultValue;
            }
        };

        const Audio = {
            initContext: function() {
                if (!AppState.audioContext) { try { AppState.audioContext = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { console.error("Web Audio API is not supported"); } }
            },
            playSound: function(frequency, duration = 1.0) {
                if (!AppState.isSoundEnabled || !AppState.audioContext) return;
                const osc = AppState.audioContext.createOscillator();
                const gain = AppState.audioContext.createGain();
                osc.frequency.value = frequency; osc.type = 'sine';
                gain.gain.setValueAtTime(0.5, AppState.audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, AppState.audioContext.currentTime + duration);
                osc.connect(gain); gain.connect(AppState.audioContext.destination);
                osc.start(AppState.audioContext.currentTime); osc.stop(AppState.audioContext.currentTime + duration);
            }
        };

        const UI = {
            showModule: function(mode) {
                AppState.currentAppMode = mode;
                const modules = ['timer', 'metronome', 'color-checker', 'food-timer', 'color-picker'];
                
                const toCamelCase = str => str.replace(/-./g, x => x[1].toUpperCase());

                modules.forEach(m => {
                    const camelCaseName = toCamelCase(m);
                    const display = UIElements[`${camelCaseName}DisplaySticky`];
                    const controls = UIElements[`${camelCaseName}Controls`];
                    
                    if (display) display.classList.toggle('active', m === mode);
                    if (controls) controls.classList.toggle('active', m === mode);
                });
                UIElements.mainLogo.classList.toggle('hidden', mode === 'donate');
                UIElements.donateOverlay.classList.remove('active');
            },
            typewriter: function(element, text, speed, onComplete = () => {}) {
                let i = 0;
                element.innerHTML = ''; 
                
                function type() {
                    if (i < text.length) {
                        element.innerHTML = text.substring(0, i + 1) + '<span class="typing-cursor"></span>';
                        i++;
                        AppState.typewriterTimeout = setTimeout(type, speed);
                    } else {
                        element.innerHTML = text; 
                        onComplete();
                    }
                }
                type();
            },
            toggleDonateOverlay: function(show) {
                 UIElements.donateOverlay.classList.toggle('active', show);
                 const line1 = UIElements.donateLine1;
                 const line2 = UIElements.donateLine2;
                 
                 clearTimeout(AppState.typewriterTimeout);
                 line1.innerHTML = '';
                 line2.innerHTML = '';

                 if(show) {
                    UIElements.mainLogo.classList.add('hidden');
                    const text1 = "Dear Supporters,";
                    const text2 = "This app was built with love to keep things simple, focused, and free. If you find it useful and want to help keep it alive, please consider a small donation.";
                    this.typewriter(line1, text1, 50, () => {
                        this.typewriter(line2, text2, 30);
                    });

                 } else {
                    UIElements.mainLogo.classList.remove('hidden');
                 }
            },
            updateTimerDisplay: function(timeLeft, totalDuration) {
                if (totalDuration <= 0) totalDuration = 1;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                UIElements.timeLeftDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                const progress = (totalDuration - timeLeft) / totalDuration;
                const isBreak = (AppState.currentTimerMode === 'pomodoro' && AppState.pomodoro.mode === 'break') || (AppState.currentTimerMode === 'sports' && !AppState.sports.isWorkout);
                let strokeColor = isBreak ? 'var(--accent-color)' : 'var(--primary-color)';
                if (!isBreak && progress >= 0.95) { strokeColor = 'var(--warning-color)'; }
                UIElements.progressCircle.style.stroke = strokeColor;
                const offset = circumference * (1 - progress);
                UIElements.progressCircle.style.strokeDashoffset = offset;
                const angle = progress * 360;
                UIElements.progressDot.parentElement.style.transform = `rotate(${angle-90}deg)`;
            },
            updateCalcTables: function() {
                UIElements.delayBpmDisplay.textContent = AppState.bpm;
                const beatMs = (60 / AppState.bpm) * 1000;
                const noteValues = [4, 2, 1, 0.5, 0.25, 0.125];
                noteValues.forEach((multiplier, index) => {
                    const noteId = `1-${Math.pow(2, index)}`;
                    const noteDuration = beatMs * multiplier;
                    document.getElementById(`t-${noteId}`).innerHTML = this.formatTimeValue(noteDuration);
                    document.getElementById(`t-${noteId}-d`).innerHTML = this.formatTimeValue(noteDuration * 1.5);
                    document.getElementById(`t-${noteId}-t`).innerHTML = this.formatTimeValue(noteDuration * (2/3));
                });
                const reverbConfigs = [
                    { id: 'hall', totalTime: beatMs * 8 }, { id: 'lroom', totalTime: beatMs * 4 },
                    { id: 'sroom', totalTime: beatMs * 2 }, { id: 'ambi', totalTime: beatMs * 1 }
                ];
                reverbConfigs.forEach(config => {
                    const predelay = config.totalTime / 64; const decay = config.totalTime - predelay;
                    document.getElementById(`r-${config.id}-pre`).innerHTML = this.formatTimeValue(predelay);
                    document.getElementById(`r-${config.id}-decay`).innerHTML = this.formatTimeValue(decay);
                    document.getElementById(`r-${config.id}-total`).innerHTML = this.formatTimeValue(config.totalTime);
                });
            },
            formatTimeValue: function(ms) {
                if (ms >= 1000) {
                    return `${(ms / 1000).toFixed(2)}<span class="time-unit">S</span>`;
                }
                return `${ms.toFixed(0)}<span class="time-unit">MS</span>`;
            }
        };

        const Timer = {
            resetAll: function() {
                clearInterval(AppState.mainTimerId); AppState.mainTimerId = null;
                AppState.targetTime = null; AppState.isPaused = true; AppState.hasStarted = false;
                UIElements.startPauseBtn.textContent = 'Start';
                UIElements.progressCircle.style.strokeDashoffset = circumference;
                UIElements.progressDot.style.display = 'block';
                AppState.pomodoroInitialState = 'work';
                if (AppState.currentTimerMode === 'pomodoro') Timer.pomodoroReset();
                if (AppState.currentTimerMode === 'sports') Timer.sportsReset();
            },
            start: function() {
                AppState.isPaused = false; AppState.hasStarted = true; UIElements.startPauseBtn.textContent = 'Pause';
                UIElements.progressDot.style.display = 'none';
                let currentLeft = AppState.currentTimerMode === 'pomodoro' ? AppState.pomodoro.timeLeft : AppState.sports.timeLeft;
                AppState.targetTime = Date.now() + currentLeft * 1000;
                AppState.mainTimerId = setInterval(AppState.currentTimerMode === 'pomodoro' ? Timer.pomodoroTick : Timer.sportsTick, 1000);
            },
            pause: function() {
                 AppState.isPaused = true; UIElements.startPauseBtn.textContent = 'Continue'; clearInterval(AppState.mainTimerId); AppState.mainTimerId = null;
                 UIElements.progressDot.style.display = 'block';
                 if(AppState.targetTime) {
                    const timeLeftOnPause = Math.round((AppState.targetTime - Date.now()) / 1000);
                    const timeToSave = timeLeftOnPause > 0 ? timeLeftOnPause : 0;
                    if (AppState.currentTimerMode === 'pomodoro') AppState.pomodoro.timeLeft = timeToSave;
                    if (AppState.currentTimerMode === 'sports') AppState.sports.timeLeft = timeToSave;
                 }
                 AppState.targetTime = null;
            },
            pomodoroReset: function() {
                const workTimeInput = document.getElementById('work-time');
                const breakTimeInput = document.getElementById('break-time');
                AppState.pomodoro = { 
                    workSec: parseInt(workTimeInput.value, 10) * 60, 
                    breakSec: parseInt(breakTimeInput.value, 10) * 60, 
                    mode: AppState.pomodoroInitialState
                };
                AppState.pomodoro.timeLeft = AppState.pomodoro.mode === 'work' ? AppState.pomodoro.workSec : AppState.pomodoro.breakSec;
                AppState.pomodoro.totalDuration = AppState.pomodoro.timeLeft;
                UIElements.modeDisplay.textContent = AppState.pomodoro.mode.charAt(0).toUpperCase() + AppState.pomodoro.mode.slice(1);
                UI.updateTimerDisplay(AppState.pomodoro.timeLeft, AppState.pomodoro.totalDuration);
            },
            pomodoroSwitch: function() {
                if (AppState.pomodoro.mode === 'work') { Audio.playSound(523.25); } else { Audio.playSound(783.99); }
                AppState.pomodoro.mode = AppState.pomodoro.mode === 'work' ? 'break' : 'work';
                AppState.pomodoro.timeLeft = AppState.pomodoro.mode === 'work' ? AppState.pomodoro.workSec : AppState.pomodoro.breakSec;
                AppState.pomodoro.totalDuration = AppState.pomodoro.timeLeft;
                UIElements.modeDisplay.textContent = AppState.pomodoro.mode.charAt(0).toUpperCase() + AppState.pomodoro.mode.slice(1);
                AppState.pomodoroInitialState = AppState.pomodoro.mode;
                AppState.targetTime = Date.now() + AppState.pomodoro.timeLeft * 1000;
                UI.updateTimerDisplay(AppState.pomodoro.timeLeft, AppState.pomodoro.totalDuration);
            },
            pomodoroTick: function() {
                let timeLeft = Math.round((AppState.targetTime - Date.now()) / 1000);
                if (timeLeft <= 0) { timeLeft = 0; Timer.pomodoroSwitch(); }
                else { AppState.pomodoro.timeLeft = timeLeft; UI.updateTimerDisplay(timeLeft, AppState.pomodoro.totalDuration); }
            },
            sportsReset: function() {
                AppState.sports = { 
                    workoutSec: parseInt(document.getElementById('workout-time').value, 10), restSec: parseInt(document.getElementById('rest-time').value, 10), 
                    totalRounds: parseInt(document.getElementById('rounds').value, 10), currentRound: 1, isWorkout: true, 
                };
                AppState.sports.timeLeft = AppState.sports.workoutSec;
                AppState.sports.totalDuration = AppState.sports.workoutSec;
                UIElements.modeDisplay.textContent = `Round ${AppState.sports.currentRound}`;
                UI.updateTimerDisplay(AppState.sports.timeLeft, AppState.sports.totalDuration);
            },
            sportsSwitch: function() {
                 if (AppState.sports.isWorkout) { Audio.playSound(523.25); AppState.sports.isWorkout = false; AppState.sports.timeLeft = AppState.sports.restSec; UIElements.modeDisplay.textContent = 'Rest'; } 
                 else { Audio.playSound(783.99); AppState.sports.currentRound++;
                    if (AppState.sports.currentRound > AppState.sports.totalRounds) { UIElements.modeDisplay.textContent = 'Complete!'; Timer.resetAll(); return; }
                    AppState.sports.isWorkout = true; AppState.sports.timeLeft = AppState.sports.workoutSec;
                    UIElements.modeDisplay.textContent = `Round ${AppState.sports.currentRound}`;
                 }
                 AppState.sports.totalDuration = AppState.sports.timeLeft;
                 AppState.targetTime = Date.now() + AppState.sports.timeLeft * 1000;
                 UI.updateTimerDisplay(AppState.sports.timeLeft, AppState.sports.totalDuration);
            },
            sportsTick: function() {
                let timeLeft = Math.round((AppState.targetTime - Date.now()) / 1000);
                if (timeLeft <= 0) { timeLeft = 0; Timer.sportsSwitch(); }
                else { AppState.sports.timeLeft = timeLeft; UI.updateTimerDisplay(timeLeft, AppState.sports.totalDuration); }
            }
        };

        const Metronome = {
            scheduleTick: function(time, currentBeat) {
                if(!AppState.audioContext) return;
                const osc = AppState.audioContext.createOscillator(); const gain = AppState.audioContext.createGain();
                osc.frequency.value = (currentBeat === 1) ? 1760 : 880; 
                gain.gain.setValueAtTime(1, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
                osc.connect(gain); gain.connect(AppState.audioContext.destination);
                osc.start(time); osc.stop(time + 0.05);
                setTimeout(() => {
                    if (currentBeat === 1) { UIElements.visualBeatIndicator.style.borderColor = 'var(--accent-color)'; UIElements.visualBeatIndicator.style.transform = 'scale(1.05)'; } 
                    else { UIElements.visualBeatIndicator.style.backgroundColor = 'rgba(255, 255, 255, 0.05)'; }
                    setTimeout(() => { UIElements.visualBeatIndicator.style.borderColor = ''; UIElements.visualBeatIndicator.style.backgroundColor = ''; UIElements.visualBeatIndicator.style.transform = ''; }, 80);
                }, (time - AppState.audioContext.currentTime) * 1000);
            },
            scheduler: function() {
                let nextNoteTime = AppState.audioContext.currentTime; const scheduleAheadTime = 0.1;
                function scheduleLoop() {
                    while (nextNoteTime < AppState.audioContext.currentTime + scheduleAheadTime) {
                        Metronome.scheduleTick(nextNoteTime, AppState.beatNumber); nextNoteTime += 60.0 / AppState.bpm; AppState.beatNumber++;
                        if (AppState.beatNumber > AppState.beatsPerMeasure) { AppState.beatNumber = 1; }
                    }
                }
                AppState.schedulerTimerID = setInterval(scheduleLoop, 25);
            },
            play: function() {
                Audio.initContext(); if(!AppState.audioContext) return;
                if (AppState.audioContext.state === 'suspended') { AppState.audioContext.resume(); }
                AppState.isMetronomePlaying = true; UIElements.playStopMetronomeBtn.textContent = 'Stop'; AppState.beatNumber = 1; Metronome.scheduler();
            },
            stop: function() {
                AppState.isMetronomePlaying = false; UIElements.playStopMetronomeBtn.textContent = 'Play'; clearInterval(AppState.schedulerTimerID);
            },
            reset: function() {
                if (AppState.isMetronomePlaying) { Metronome.stop(); }
                AppState.bpm = 135; UIElements.bpmDisplay.textContent = AppState.bpm; UIElements.bpmSlider.value = AppState.bpm;
                AppState.tapTimestamps = []; clearTimeout(AppState.tapTimeoutId); UI.updateCalcTables();
                Storage.save('bpm', AppState.bpm);
            },
            handleBpmTap: function() {
                const now = Date.now(); clearTimeout(AppState.tapTimeoutId); AppState.tapTimestamps.push(now);
                if (AppState.tapTimestamps.length > 5) { AppState.tapTimestamps.shift(); }
                if (AppState.tapTimestamps.length > 1) {
                    const intervals = [];
                    for (let i = 1; i < AppState.tapTimestamps.length; i++) { intervals.push(AppState.tapTimestamps[i] - AppState.tapTimestamps[i-1]); }
                    const averageInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
                    if (averageInterval > 0) {
                        let newBpm = Math.round(60000 / averageInterval);
                        newBpm = Math.max(40, Math.min(220, newBpm));
                        AppState.bpm = newBpm; UIElements.bpmDisplay.textContent = AppState.bpm; UIElements.bpmSlider.value = AppState.bpm; 
                        UI.updateCalcTables(); Storage.save('bpm', AppState.bpm);
                    }
                }
                AppState.tapTimeoutId = setTimeout(() => { AppState.tapTimestamps = []; }, 2000); 
            }
        };

        const Camelot = {
            mode: 'key',
            selectedKey: null,
            wheelData: [
                { num: 1, A: 'G♯m', B: 'B' }, { num: 2, A: 'D♯m', B: 'F♯' }, { num: 3, A: 'A♯m', B: 'C♯' },
                { num: 4, A: 'Fm', B: 'A♭' }, { num: 5, A: 'Cm', B: 'E♭' }, { num: 6, A: 'Gm', B: 'B♭' },
                { num: 7, A: 'Dm', B: 'F' }, { num: 8, A: 'Am', B: 'C' }, { num: 9, A: 'Em', B: 'G' },
                { num: 10, A: 'Bm', B: 'D' }, { num: 11, A: 'F♯m', B: 'A' }, { num: 12, A: 'C♯m', B: 'E' },
            ],
            init: function() { this.drawTable(); },
            drawTable: function() {
                UIElements.camelotTableBody.innerHTML = '';
                this.wheelData.forEach(row => {
                    const tr = document.createElement('tr');
                    const tdA = document.createElement('td');
                    tdA.classList.add('key-cell');
                    tdA.dataset.id = `${row.num}A`;
                    tdA.textContent = `${row.num}A - ${row.A}`;
                    const tdB = document.createElement('td');
                    tdB.classList.add('key-cell');
                    tdB.dataset.id = `${row.num}B`;
                    tdB.textContent = `${row.num}B - ${row.B}`;
                    tr.appendChild(tdA);
                    tr.appendChild(tdB);
                    UIElements.camelotTableBody.appendChild(tr);
                });
            },
            handleSelection: function(event) {
                const selectedCell = event.target.closest('.key-cell');
                if (!selectedCell) return;
                this.selectedKey = selectedCell.dataset.id;
                this.updateHighlighting();
            },
            updateHighlighting: function() {
                if (!this.selectedKey) return;
                const selectedId = this.selectedKey;
                const num = parseInt(selectedId.slice(0, -1));
                const mode = selectedId.slice(-1);
                const fullKeyName = this.wheelData.find(r => r.num === num)[mode];
                UIElements.camelotViewTitle.textContent = `${selectedId} - ${fullKeyName}`;
                let compatible = [];
                let sequenceStep1 = null, sequenceStep2 = null, switchKey = null;

                if (this.mode === 'key') {
                    compatible.push(((num - 2 + 12) % 12 + 1) + mode);
                    compatible.push((num % 12 + 1) + mode);
                    compatible.push(num + (mode === 'A' ? 'B' : 'A'));
                } else {
                    sequenceStep1 = ((num - 1 + 3) % 12 + 1) + mode;
                    sequenceStep2 = ((num - 1 + 8) % 12 + 1) + mode;
                    switchKey = ((num - 1 + 1) % 12 + 1) + mode;
                }
                
                document.querySelectorAll('.key-cell').forEach(cell => {
                    const cellId = cell.dataset.id;
                    cell.classList.remove('selected', 'compatible', 'sequence-step1', 'sequence-step2', 'switch-key');
                    if (cellId === selectedId) cell.classList.add('selected');
                    else if (this.mode === 'key' && compatible.includes(cellId)) cell.classList.add('compatible');
                    else if (this.mode === 'sequence') {
                        if (cellId === sequenceStep1) cell.classList.add('sequence-step1');
                        else if (cellId === sequenceStep2) cell.classList.add('sequence-step2');
                        else if (cellId === switchKey) cell.classList.add('switch-key');
                    }
                });
            },
            setMode: function(newMode) {
                this.mode = newMode;
                this.updateHighlighting();
            }
        };

        const ColorChecker = {
            colors: [
                { name: 'Dark Skin', hex: '#735244' }, { name: 'Light Skin', hex: '#c29682' },
                { name: 'Blue Sky', hex: '#688bc3' }, { name: 'Foliage', hex: '#67a070' },
                { name: 'Blue Flower', hex: '#6058a0' }, { name: 'Bluish Green', hex: '#58c5b6' },
                { name: 'Orange', hex: '#d17b43' }, { name: 'Purplish Blue', hex: '#515a96' },
                { name: 'Moderate Red', hex: '#c05b8a' }, { name: 'Purple', hex: '#8e59a9' },
                { name: 'Yellow Green', hex: '#a1b758' }, { name: 'Orange Yellow', hex: '#e7a23d' },
                { name: 'Blue', hex: '#3e498c' }, { name: 'Green', hex: '#4d9d6d' },
                { name: 'Red', hex: '#b54b48' }, { name: 'Yellow', hex: '#e9c73e' },
                { name: 'Magenta', hex: '#be6ea2' }, { name: 'Cyan', hex: '#5095c4' },
                { name: 'White', hex: '#f3f3f2' }, { name: 'Neutral 8', hex: '#c8c8c8' },
                { name: 'Neutral 6.5', hex: '#9a9a9a' }, { name: 'Neutral 5', hex: '#787878' },
                { name: 'Neutral 3.5', hex: '#454545' }, { name: 'Black', hex: '#202020' }
            ],
            init: function() {
                this.drawChecker();
                this.updateInfo(this.colors[0]);
                document.querySelector('.color-swatch').classList.add('selected');
            },
            drawChecker: function() {
                UIElements.colorCheckerGrid.innerHTML = '';
                this.colors.forEach(color => {
                    const swatch = document.createElement('div');
                    swatch.classList.add('color-swatch');
                    swatch.style.backgroundColor = color.hex;
                    swatch.dataset.name = color.name;
                    swatch.dataset.hex = color.hex;
                    UIElements.colorCheckerGrid.appendChild(swatch);
                });
            },
            updateInfo: function(color) {
                const rgb = ColorUtils.hexToRgb(color.hex);
                UIElements.colorNameValue.textContent = color.name;
                UIElements.colorHexValue.textContent = color.hex;
                UIElements.colorRgbValue.textContent = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
            },
            handleSelection: function(event) {
                const swatch = event.target.closest('.color-swatch');
                if (!swatch) return;
                document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
                swatch.classList.add('selected');
                this.updateInfo(swatch.dataset);
            },
        };

        const ColorPaletteTool = {
            ratioPresets: {
                bladeRunnerRatios: [30, 25, 20, 15, 10],
                herRatios: [40, 25, 15, 10, 10],
                madMaxRatios: [40, 35, 15, 5, 5],
                jokerRatios: [30, 25, 20, 15, 10],
                sixtyThirtyTen: [60, 30, 10],
                complementary: [75, 25],
                triadic: [34, 33, 33],
                analogous: [60, 25, 15],
            },
            init: function() { 
                this.loadSwatchesFromStorage(); 
                this.analyzeContrast();
            },
            openEyeDropper: async function() {
                if (!window.EyeDropper) {
                    alert("Your browser doesn't support the EyeDropper API yet.");
                    return;
                }
                try {
                    const eyeDropper = new EyeDropper();
                    const result = await eyeDropper.open();
                    this.addSwatch(result.sRGBHex.toUpperCase());
                } catch (e) {
                    console.log('EyeDropper was cancelled.');
                }
            },
            addSwatch: function(hex, ratio = 0, isLocked = false, fromStorage = false) {
                const swatch = document.createElement('div');
                swatch.className = 'palette-swatch';
                swatch.style.backgroundColor = hex;
                swatch.dataset.hex = hex;
                swatch.dataset.locked = isLocked;
                if(isLocked) swatch.classList.add('locked');

                swatch.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
                        navigator.clipboard.writeText(hex);
                        e.target.style.borderColor = 'var(--primary-color)';
                        setTimeout(() => { swatch.style.borderColor = '' }, 500);
                    }
                });

                const ratioInput = document.createElement('input');
                ratioInput.type = 'number';
                ratioInput.className = 'swatch-ratio-input';
                ratioInput.placeholder = '%';
                ratioInput.value = ratio;
                ratioInput.addEventListener('change', () => this.saveSwatchesToStorage());
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'swatch-delete-btn';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    swatch.remove();
                    this.saveSwatchesToStorage();
                });

                const lockBtn = document.createElement('button');
                lockBtn.className = 'swatch-lock-btn';
                lockBtn.innerHTML = isLocked ? '&#128274;' : '&#128275;';
                if(isLocked) lockBtn.classList.add('locked');
                lockBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const currentlyLocked = swatch.dataset.locked === 'true';
                    swatch.dataset.locked = !currentlyLocked;
                    swatch.classList.toggle('locked');
                    lockBtn.innerHTML = !currentlyLocked ? '&#128274;' : '&#128275;';
                    lockBtn.classList.toggle('locked');
                    this.saveSwatchesToStorage();
                });
                
                swatch.appendChild(lockBtn);
                swatch.appendChild(deleteBtn);
                swatch.appendChild(ratioInput);
                UIElements.paletteSwatchesContainer.appendChild(swatch);
                if (!fromStorage) this.saveSwatchesToStorage();
            },
            getSwatchesData: function(includeNode = false) {
                const swatches = [];
                document.querySelectorAll('.palette-swatch').forEach(sw => {
                    const data = {
                        hex: sw.dataset.hex,
                        ratio: sw.querySelector('.swatch-ratio-input').value || 0,
                        isLocked: sw.dataset.locked === 'true'
                    };
                    if(includeNode) data.node = sw;
                    swatches.push(data);
                });
                return swatches;
            },
            saveSwatchesToStorage: function() {
                const swatchesData = this.getSwatchesData();
                Storage.save('colorPalette', swatchesData);
                this.updateRatioChart();
                this.analyzeContrast();
            },
            loadSwatchesFromStorage: function() {
                const swatchesData = Storage.get('colorPalette', []);
                UIElements.paletteSwatchesContainer.innerHTML = '';
                swatchesData.forEach(s => this.addSwatch(s.hex, s.ratio, s.isLocked, true));
                this.updateRatioChart();
                this.analyzeContrast();
            },
            copyAllSwatches: function() {
                const hexCodes = this.getSwatchesData().map(s => s.hex).join(', ');
                navigator.clipboard.writeText(hexCodes);
            },
            clearAllSwatches: function() {
                document.querySelectorAll('.palette-swatch:not(.locked)').forEach(sw => sw.remove());
                this.saveSwatchesToStorage();
            },
            updateRatioChart: function() {
                const swatchesData = this.getSwatchesData();
                const totalRatio = swatchesData.reduce((sum, s) => sum + Number(s.ratio), 0);
                UIElements.paletteRatioChart.innerHTML = '';

                if (totalRatio === 0) return;

                swatchesData.forEach(s => {
                    if (s.ratio > 0) {
                        const segment = document.createElement('div');
                        segment.className = 'ratio-bar-segment';
                        segment.style.backgroundColor = s.hex;
                        segment.style.width = `${(s.ratio / totalRatio) * 100}%`;
                        UIElements.paletteRatioChart.appendChild(segment);
                    }
                });
            },
            applyRatioPreset: function() {
                const presetName = UIElements.paletteRatioPresetSelect.value;
                if (!presetName || !this.ratioPresets[presetName]) return;

                const ratios = this.ratioPresets[presetName];
                AppState.palette.lastUsedRatios = [...ratios];
                const swatches = document.querySelectorAll('.palette-swatch');

                swatches.forEach((swatch, index) => {
                    const ratioInput = swatch.querySelector('.swatch-ratio-input');
                    ratioInput.value = ratios[index] || 0;
                });

                this.saveSwatchesToStorage();
                UIElements.paletteRatioPresetSelect.value = '';
            },
            randomizeRatios: function() {
                let ratiosToShuffle = AppState.palette.lastUsedRatios;
                if (!ratiosToShuffle || ratiosToShuffle.length === 0) {
                    ratiosToShuffle = this.getSwatchesData().map(s => s.ratio);
                }
                
                for (let i = ratiosToShuffle.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [ratiosToShuffle[i], ratiosToShuffle[j]] = [ratiosToShuffle[j], ratiosToShuffle[i]];
                }
                
                const swatches = document.querySelectorAll('.palette-swatch');
                swatches.forEach((swatch, index) => {
                    const ratioInput = swatch.querySelector('.swatch-ratio-input');
                    ratioInput.value = ratiosToShuffle[index] || 0;
                });
                
                this.saveSwatchesToStorage();
            },
             analyzeContrast: function() {
                const swatches = this.getSwatchesData().filter(s => Number(s.ratio) > 0);
                if (swatches.length < 2) {
                    UIElements.paletteContrastValue.textContent = 'N/A';
                    return;
                }

                const totalWeight = swatches.reduce((sum, s) => sum + Number(s.ratio), 0);
                if(totalWeight === 0) {
                     UIElements.paletteContrastValue.textContent = 'N/A';
                    return;
                }

                const weightedMean = swatches.reduce((sum, s) => sum + (ColorUtils.getLuminance(s.hex) * Number(s.ratio)), 0) / totalWeight;
                const weightedVariance = swatches.reduce((sum, s) => sum + (Number(s.ratio) * Math.pow(ColorUtils.getLuminance(s.hex) - weightedMean, 2)), 0) / totalWeight;
                const stdDev = Math.sqrt(weightedVariance);

                let rating = 'Flat';
                if (stdDev > 40) rating = 'Dynamic';
                else if (stdDev > 20) rating = 'Good';

                UIElements.paletteContrastValue.textContent = `${rating} (σ=${stdDev.toFixed(1)})`;
            },
            randomizeContrast: function() {
                const swatches = this.getSwatchesData(true);
                if (swatches.length < 2) return;

                const hslSwatches = swatches.map(s => ({ ...ColorUtils.hexToHsl(s.hex), node: s.node, originalHex: s.hex }));
                hslSwatches.sort((a, b) => a.l - b.l); 

                const n = swatches.length;
                const targetLightness = Array.from({ length: n }, (_, i) => 0.1 + (i * (0.8 / (n - 1))));
                
                for (let i = targetLightness.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [targetLightness[i], targetLightness[j]] = [targetLightness[j], targetLightness[i]];
                }

                hslSwatches.forEach((swatch, index) => {
                    const newHsl = { h: swatch.h, s: swatch.s, l: targetLightness[index] };
                    const newHex = ColorUtils.hslToHex(newHsl);
                    
                    swatch.node.dataset.hex = newHex;
                    swatch.node.style.backgroundColor = newHex;
                });

                this.saveSwatchesToStorage();
            },
            exportToNotepad: function() {
                const swatchesData = this.getSwatchesData();
                if(swatchesData.length === 0) return;
                
                let exportText = `\n\n--- Color Palette (${new Date().toLocaleString()}) ---\n`;
                swatchesData.forEach(s => {
                    exportText += `${s.hex} (${s.ratio}%)\n`;
                });
                exportText += '------------------------------------------\n';
                
                Notepad.appendToNote(exportText);
            }
        };

        const ColorUtils = {
            hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                  r: parseInt(result[1], 16),
                  g: parseInt(result[2], 16),
                  b: parseInt(result[3], 16)
                } : null;
            },
            getLuminance(hex) {
                const rgb = this.hexToRgb(hex);
                if (!rgb) return 0;
                return 0.2126 * rgb.r + 0.7152 * rgb.g + 0.0722 * rgb.b;
            },
            hexToHsl(hex) {
                const rgb = this.hexToRgb(hex);
                const r = rgb.r / 255, g = rgb.g / 255, b = rgb.b / 255;
                const max = Math.max(r, g, b), min = Math.min(r, g, b);
                let h = 0, s, l = (max + min) / 2;

                if (max !== min) {
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    switch (max) {
                        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                        case g: h = (b - r) / d + 2; break;
                        case b: h = (r - g) / d + 4; break;
                    }
                    h /= 6;
                } else {
                   h = s = 0; 
                }
                return { h, s, l };
            },
            hslToHex({h, s, l}) {
                let r, g, b;
                if (s === 0) {
                    r = g = b = l; 
                } else {
                    const hue2rgb = (p, q, t) => {
                        if (t < 0) t += 1;
                        if (t > 1) t -= 1;
                        if (t < 1/6) return p + (q - p) * 6 * t;
                        if (t < 1/2) return q;
                        if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                        return p;
                    };
                    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                    const p = 2 * l - q;
                    r = hue2rgb(p, q, h + 1/3);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1/3);
                }
                const toHex = x => {
                    const hex = Math.round(x * 255).toString(16);
                    return hex.length === 1 ? '0' + hex : hex;
                };
                return `#${toHex(r)}${toHex(g)}${toHex(b)}`.toUpperCase();
            }
        };

        const SnackTime = {
            foodData: {
                meals: [
                    { name: 'Greek Salad', water: 85, macros: [ { name: 'Carbs', percent: 14, color: 'var(--carbs-color)' }, { name: 'Protein', percent: 7, color: 'var(--protein-color)' }, { name: 'Fats', percent: 79, color: 'var(--fats-color)' } ] },
                    { name: 'Avocado Toast', water: 75, macros: [ { name: 'Carbs', percent: 45, color: 'var(--carbs-color)' }, { name: 'Protein', percent: 15, color: 'var(--protein-color)' }, { name: 'Fats', percent: 40, color: 'var(--fats-color)' } ] },
                    { name: 'Margarita Pizza', water: 60, macros: [ { name: 'Carbs', percent: 55, color: 'var(--carbs-color)' }, { name: 'Protein', percent: 20, color: 'var(--protein-color)' }, { name: 'Fats', percent: 25, color: 'var(--fats-color)' } ] },
                ],
                snacks: [
                    { name: 'Watermelon & Honey', water: 92, macros: [ { name: 'Carbs', percent: 93, color: 'var(--carbs-color)' }, { name: 'Protein', percent: 5, color: 'var(--protein-color)' }, { name: 'Fats', percent: 2, color: 'var(--fats-color)' } ] },
                    { name: 'Snickers', water: 10, macros: [ { name: 'Carbs', percent: 55, color: 'var(--carbs-color)' }, { name: 'Protein', percent: 10, color: 'var(--protein-color)' }, { name: 'Fats', percent: 35, color: 'var(--fats-color)' } ] },
                    { name: "Ben & Jerry's", water: 60, macros: [ { name: 'Carbs', percent: 50, color: 'var(--carbs-color)' }, { name: 'Protein', percent: 10, color: 'var(--protein-color)' }, { name: 'Fats', percent: 40, color: 'var(--fats-color)' } ] },
                ]
            },
            init: function() {
                this.generateRandom('snacks');
            },
            generateRandom(type) {
                const list = this.foodData[type];
                const randomItem = list[Math.floor(Math.random() * list.length)];
                this.updateDisplay(randomItem);
            },
            updateDisplay: function(food) {
                const titleEl = UIElements.foodTimerTitle;
                titleEl.textContent = food.name.toUpperCase();
                titleEl.classList.remove('pulsating-title');
                void titleEl.offsetWidth;
                titleEl.classList.add('pulsating-title');
                
                const percentagesDiv = UIElements.foodPercentagesDisplay;
                percentagesDiv.innerHTML = ''; 
                
                const waterSpan = document.createElement('span');
                waterSpan.textContent = `${food.water}% Water`;
                waterSpan.style.color = 'var(--water-color)';
                waterSpan.classList.add('macro-percentage');
                percentagesDiv.appendChild(waterSpan);
                
                const macroRow = document.createElement('div');
                macroRow.classList.add('macro-percentage-row');

                food.macros.forEach(macro => {
                    if(macro.percent > 0) {
                        const span = document.createElement('span');
                        span.textContent = `${macro.percent}%`;
                        span.style.color = macro.color;
                        span.classList.add('macro-percentage');
                        macroRow.appendChild(span);
                    }
                });
                percentagesDiv.appendChild(macroRow);
                this.drawMacroRing(food.macros);
                this.updateWaterRing(food.water);
            },
            updateWaterRing: function(percent) {
                const ring = UIElements.waterRing;
                const radius = ring.r.baseVal.value;
                const circumference = 2 * Math.PI * radius;
                const offset = circumference - (percent / 100 * circumference);
                ring.style.strokeDasharray = `${circumference} ${circumference}`;
                ring.style.strokeDashoffset = offset;
            },
            drawMacroRing: function(data) {
                const slicesGroup = UIElements.pieChartSlices;
                slicesGroup.innerHTML = '';
                const radius = 39;
                const strokeWidth = 6; 
                const circumference = 2 * Math.PI * radius;
                let cumulativeRotation = 0;
                slicesGroup.setAttribute('transform', 'rotate(-90 50 50)');
                data.forEach(slice => {
                    if (slice.percent === 0) return;
                    const arcLength = (slice.percent / 100) * circumference;
                    const newRing = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    newRing.setAttribute('cx', 50);
                    newRing.setAttribute('cy', 50);
                    newRing.setAttribute('r', radius);
                    newRing.setAttribute('fill', 'none');
                    newRing.setAttribute('stroke', slice.color);
                    newRing.setAttribute('stroke-width', strokeWidth);
                    newRing.setAttribute('stroke-dasharray', `${arcLength} ${circumference}`);
                    newRing.setAttribute('class', 'macro-ring-slice');
                    newRing.style.transform = `rotate(${cumulativeRotation}deg)`;
                    slicesGroup.appendChild(newRing);
                    cumulativeRotation += (slice.percent / 100) * 360;
                });
            }
        };

        const Notepad = {
            init: function() {
                this.loadNote();
                UIElements.copyNotesBtn.addEventListener('click', this.copyNote.bind(this));
                UIElements.clearNotesBtn.addEventListener('click', this.clearNote.bind(this));
            },
            saveNote: function() {
                Storage.save('notepadContent', UIElements.notepadTextarea.value);
            },
            loadNote: function() {
                UIElements.notepadTextarea.value = Storage.get('notepadContent', '');
            },
            appendToNote: function(text) {
                UIElements.notepadTextarea.value += text;
                this.saveNote();
            },
            copyNote: function() {
                const textarea = UIElements.notepadTextarea;
                if (textarea.value) {
                    textarea.select();
                    textarea.setSelectionRange(0, 99999); 
                    try {
                        document.execCommand('copy');
                        UIElements.copyNotesBtn.textContent = 'Copied!';
                        setTimeout(() => { UIElements.copyNotesBtn.textContent = 'Copy'; }, 1500);
                    } catch (err) { console.error('Fallback: Oops, unable to copy', err); }
                    window.getSelection().removeAllRanges();
                }
            },
            clearNote: function() {
                UIElements.notepadTextarea.value = '';
                this.saveNote();
            }
        };


        // --- Event Listeners & Initializer ---
        function toggleMainOptions(shouldHide) {
             UIElements.timerOptionsWrapper.classList.toggle('hidden', shouldHide);
        }

        function setupEventListeners() {
            UIElements.menuIcon.addEventListener('click', () => {
                UIElements.leftIconMenu.classList.toggle('menu-open');
            });
            
            UIElements.metronomeIcon.addEventListener('click', () => UI.showModule('metronome'));
            UIElements.bellIcon.addEventListener('click', () => {
                AppState.isSoundEnabled = !AppState.isSoundEnabled;
                UIElements.bellIcon.src = AppState.isSoundEnabled ? AppState.bellEnabledSrc : AppState.bellDisabledSrc;
                Storage.save('soundEnabled', AppState.isSoundEnabled);
            });
            UIElements.colorCheckerIcon.addEventListener('click', () => UI.showModule('color-checker'));
            UIElements.foodTimerIcon.addEventListener('click', () => UI.showModule('food-timer'));
            UIElements.colorPickerIcon.addEventListener('click', () => UI.showModule('color-picker'));

            UIElements.mainLogo.addEventListener('click', () => UI.toggleDonateOverlay(true));
            UIElements.closeDonateBtn.addEventListener('click', () => UI.toggleDonateOverlay(false));

            UIElements.notepadIcon.addEventListener('click', () => {
                const isNotepadVisible = UIElements.notepadPanel.classList.toggle('visible');
                const anyPanelVisible = isNotepadVisible || UIElements.calcPanel.classList.contains('visible') || UIElements.camelotPanel.classList.contains('visible');
                
                UIElements.appWrapper.classList.toggle('is-panel-open', anyPanelVisible);
                toggleMainOptions(anyPanelVisible);
            });


            UIElements.backToTimerBtn.addEventListener('click', () => {
                if (AppState.isMetronomePlaying) Metronome.stop();
                UI.showModule('timer');
            });
            UIElements.backToTimerFromChecker.addEventListener('click', () => UI.showModule('timer'));
            UIElements.backToTimerFromFood.addEventListener('click', () => UI.showModule('timer'));
            UIElements.backToTimerFromPicker.addEventListener('click', () => UI.showModule('timer'));

            UIElements.openCalcBtn.addEventListener('click', () => {
                const isCalcVisible = UIElements.calcPanel.classList.toggle('visible');
                const anyPanelVisible = isCalcVisible || UIElements.camelotPanel.classList.contains('visible') || UIElements.notepadPanel.classList.contains('visible');
                UIElements.appWrapper.classList.toggle('is-panel-open', anyPanelVisible);
                UIElements.openCalcBtn.textContent = isCalcVisible ? "Close" : "Calculators";
                toggleMainOptions(anyPanelVisible);
                if(isCalcVisible) { UI.updateCalcTables(); }
            });
            UIElements.openCamelotBtn.addEventListener('click', () => {
                const isCamelotVisible = UIElements.camelotPanel.classList.toggle('visible');
                const anyPanelVisible = isCamelotVisible || UIElements.calcPanel.classList.contains('visible') || UIElements.notepadPanel.classList.contains('visible');
                UIElements.appWrapper.classList.toggle('is-panel-open', anyPanelVisible);
                UIElements.openCamelotBtn.textContent = isCamelotVisible ? "Close" : "Camelot";
                toggleMainOptions(anyPanelVisible);
            });
            
            UIElements.startPauseBtn.addEventListener('click', () => {
                Audio.initContext();
                if (AppState.isPaused) {
                    if (!AppState.hasStarted) { Timer.pomodoroReset(); }
                    Timer.start(); 
                } 
                else { Timer.pause(); }
            });
            UIElements.resetBtn.addEventListener('click', Timer.resetAll);
            
            document.querySelectorAll('#pomodoro-settings .setting-item.label').forEach(el => {
                el.addEventListener('click', () => {
                    if (AppState.currentTimerMode === 'pomodoro' && !AppState.hasStarted) {
                        AppState.pomodoroInitialState = el.dataset.startMode;
                        Timer.pomodoroReset();
                    }
                });
            });


            UIElements.allTimerInputs.forEach(input => {
                input.addEventListener('change', () => {
                    if(!AppState.hasStarted) {
                         if (AppState.currentTimerMode === 'pomodoro') Timer.pomodoroReset();
                         if (AppState.currentTimerMode === 'sports') Timer.sportsReset();
                    }
                    Storage.save('pomodoroWork', document.getElementById('work-time').value);
                    Storage.save('pomodoroBreak', document.getElementById('break-time').value);
                    Storage.save('sportsWorkout', document.getElementById('workout-time').value);
                    Storage.save('sportsRest', document.getElementById('rest-time').value);
                    Storage.save('sportsRounds', document.getElementById('rounds').value);
                });
            });
            UIElements.modeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const mode = btn.dataset.mode;
                    if (mode === AppState.currentTimerMode) return;
                    AppState.currentTimerMode = mode;
                    Storage.save('timerMode', mode);
                    UIElements.modeBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    UIElements.pomodoroSettings.classList.toggle('active', mode === 'pomodoro');
                    UIElements.sportsSettings.classList.toggle('active', mode === 'sports');
                    Timer.resetAll();
                });
            });
            UIElements.playStopMetronomeBtn.addEventListener('click', () => { AppState.isMetronomePlaying ? Metronome.stop() : Metronome.play(); });
            UIElements.bpmSlider.addEventListener('input', (e) => { 
                AppState.bpm = e.target.value; 
                UIElements.bpmDisplay.textContent = AppState.bpm; 
                UI.updateCalcTables(); 
            });
            UIElements.bpmSlider.addEventListener('change', () => Storage.save('bpm', AppState.bpm));
            UIElements.visualBeatIndicator.addEventListener('click', Metronome.handleBpmTap);
            UIElements.resetMetronomeBtn.addEventListener('click', Metronome.reset);
            
            if (UIElements.camelotTableBody) {
                UIElements.camelotTableBody.addEventListener('click', Camelot.handleSelection.bind(Camelot));
            }
            UIElements.camelotModeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    UIElements.camelotModeBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    Camelot.setMode(btn.dataset.mode);
                });
            });

            UIElements.colorCheckerGrid.addEventListener('click', ColorChecker.handleSelection.bind(ColorChecker));

            UIElements.fullscreenBtn.addEventListener('click', () => {
                try {
                    const elementToFullscreen = document.getElementById('color-checker-container');
                    if (document.fullscreenElement) { document.exitFullscreen(); } 
                    else { elementToFullscreen.requestFullscreen(); }
                } catch (error) { console.error("Fullscreen API error:", error); }
            });

            // Snack Time listeners
            UIElements.generateMealBtn.addEventListener('click', () => SnackTime.generateRandom('meals'));
            UIElements.generateSnackBtn.addEventListener('click', () => SnackTime.generateRandom('snacks'));

            // Color Palette Tool Listeners
            UIElements.eyedropperBtn.addEventListener('click', () => ColorPaletteTool.openEyeDropper());
            UIElements.paletteCopyAllBtn.addEventListener('click', () => ColorPaletteTool.copyAllSwatches());
            UIElements.paletteClearBtn.addEventListener('click', () => ColorPaletteTool.clearAllSwatches());
            UIElements.paletteRatioPresetSelect.addEventListener('change', () => ColorPaletteTool.applyRatioPreset());
            UIElements.paletteRandomizeBtn.addEventListener('click', () => ColorPaletteTool.randomizeRatios());
            UIElements.paletteRandomContrastBtn.addEventListener('click', () => ColorPaletteTool.randomizeContrast());
            UIElements.paletteExportBtn.addEventListener('click', () => ColorPaletteTool.exportToNotepad());
            UIElements.paletteSwatchesContainer.addEventListener('change', (e) => {
                if(e.target.classList.contains('swatch-ratio-input')) {
                    ColorPaletteTool.saveSwatchesToStorage();
                }
            });

        }

        function initializeApp() {
            document.getElementById('work-time').value = Storage.get('pomodoroWork', 25);
            document.getElementById('break-time').value = Storage.get('pomodoroBreak', 5);
            document.getElementById('workout-time').value = Storage.get('sportsWorkout', 45);
            document.getElementById('rest-time').value = Storage.get('sportsRest', 15);
            document.getElementById('rounds').value = Storage.get('sportsRounds', 8);
            AppState.currentTimerMode = Storage.get('timerMode', 'pomodoro');
            UIElements.modeBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === AppState.currentTimerMode);
            });
            UIElements.pomodoroSettings.classList.toggle('active', AppState.currentTimerMode === 'pomodoro');
            UIElements.sportsSettings.classList.toggle('active', AppState.currentTimerMode === 'sports');
            AppState.bpm = Storage.get('bpm', 135);
            UIElements.bpmDisplay.textContent = AppState.bpm;
            UIElements.bpmSlider.value = AppState.bpm;
            AppState.isSoundEnabled = Storage.get('soundEnabled', true);
            UIElements.bellIcon.src = AppState.isSoundEnabled ? AppState.bellEnabledSrc : AppState.bellDisabledSrc;

            Camelot.init();
            ColorChecker.init();
            SnackTime.init();
            Notepad.init();
            ColorPaletteTool.init();
            setupEventListeners();
            UI.showModule('timer');
            Timer.resetAll();
            UI.updateCalcTables();
        }

        initializeApp();
    });
    </script>
</body>
</html>
