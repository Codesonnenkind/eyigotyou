<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EYIGOTYOU</title>
    <!-- RESTORED: Original Favicon Link -->
    <link rel="icon" type="image/jpeg" href="https://www.dropbox.com/scl/fi/n2ez50rho6xydpma93sq2/500.jpeg?rlkey=8omntfna9sqvagk8p6cs7gjwh&raw=1" onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>E</text></svg>'">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-color: #0A0A0A;
            --primary-color: #FFFFFF;
            --secondary-color: #888888;
            --accent-color: #1E8449; /* Green for breaks and positive actions */
            --warning-color: #EF4444; /* Red for alerts */
        }

        html, body {
            height: 100%;
            margin: 0;
            background-color: var(--background-color);
            color: var(--secondary-color);
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            overflow: hidden; 
            overflow-x: hidden; 
        }

        #app-wrapper {
             display: flex;
             flex-direction: column;
             align-items: center;
             width: 100%;
             height: 100%;
             max-height: 100%;
             overflow-y: hidden;
             padding: 0 20px 20px 20px; /* Adjusted padding */
             box-sizing: border-box;
        }

        #app-wrapper.is-calculator-open {
            overflow-y: auto;
        }
        
        /* --- Corner Icons (RESTORED to original) --- */
        .site-logo {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 45px;
            height: auto;
            z-index: 100;
        }
        
        .site-icon-left {
            position: fixed;
            top: 15px;
            left: 15px;
            width: 32px;
            height: auto;
            z-index: 100;
            filter: invert(100%);
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        
        .site-icon-left:hover {
            transform: scale(1.1);
        }

        #bell-icon {
            top: 65px; /* Position below the first icon */
        }


        /* --- Main Module Containers --- */
        .module {
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 320px;
        }

        .module.active {
            display: flex; /* Show active module */
        }
        
        .module-container {
            background-color: transparent;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            position: relative;
            width: 100%;
        }
        
        /* ADDED: Wrapper for sticky display elements */
        .sticky-wrapper {
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: var(--background-color);
            padding-top: 5vh; 
            padding-bottom: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        /* --- Timer Specific --- */
        .timer-container {
            position: relative;
            width: 65vw; 
            height: 65vw;
            max-width: 240px; 
            max-height: 240px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: default;
            /* REMOVED: margin-top handled by sticky-wrapper */
        }

        .timer-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .timer-circle {
            fill: none;
            stroke-width: 4; 
        }
        
        #timer-track { stroke: var(--secondary-color); opacity: 0.1; }

        #timer-progress {
            stroke: var(--primary-color);
            stroke-linecap: round;
            transition: stroke 0.5s ease-in-out, stroke-dashoffset 0.2s linear;
        }
        
        #progress-dot {
            fill: var(--primary-color);
            transition: fill 0.5s ease-in-out;
            animation: pulsate 1.5s infinite alternate ease-in-out;
        }

        @keyframes pulsate {
            from { r: 1; }
            to { r: 3; }
        }

        #time-left {
            z-index: 1; 
            font-size: clamp(2rem, 10vw, 3rem); 
            font-weight: 700;
            letter-spacing: 0.1em;
            color: var(--primary-color);
        }
        
        #mode-display, #calc-view-title {
            z-index: 2;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: var(--secondary-color);
            transition: color 0.5s ease-in-out;
            text-align: center;
            height: 1em; /* Reserve space */
            margin-bottom: 5px;
        }
        
        /* --- Metronome Specific --- */
        .metronome-display {
            width: 65vw; 
            height: 65vw;
            max-width: 240px;
            max-height: 240px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            border: 12px solid rgba(136, 136, 136, 0.1);
            border-radius: 50%;
            transition: border-color 0.1s ease, background-color 0.1s ease, transform 0.1s ease-out;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            box-sizing: border-box;
        }

        #bpm-display {
            font-size: clamp(2.5rem, 11vw, 3.5rem); 
            font-weight: 700;
            color: var(--primary-color);
        }
        #bpm-label {
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: var(--secondary-color);
        }
        
        /* --- Generic Controls --- */
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 240px;
        }

        .control-group {
            display: flex;
            border: 2px solid var(--secondary-color);
            overflow: hidden;
        }
        
        .control-btn, .mode-btn, .setting-item {
            background-color: transparent;
            border: none;
            color: var(--secondary-color);
            padding: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center; 
            gap: 8px;
            cursor: pointer;
            flex: 1;
        }
        
        .control-group > *:not(:last-child) {
             border-right: 2px solid var(--secondary-color);
        }

        .mode-btn.active {
            background-color: var(--secondary-color);
            color: var(--background-color);
        }
        
        .control-btn:hover, .mode-btn:not(.active):hover, #reset-metronome:hover {
            color: var(--primary-color);
        }

        /* Asymmetrical Sizing & Layout */
        .mode-btn[data-mode="pomodoro"], #start-pause-btn, .setting-item.label { 
            flex-grow: 2;
            justify-content: flex-start;
            padding-left: 15px;
        }

        #play-stop-metronome, .back-button {
            flex-basis: 100%;
            justify-content: center;
        }

        #reset-metronome {
            flex-grow: 1;
            flex-basis: 0;
        }
        #bpm-slider-container {
            flex-grow: 2;
            flex-basis: 0;
        }
        
        /* --- Sliders and Inputs --- */
        #settings-container {
             position: relative;
             height: 125px; 
        }

        .settings-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
        }
        .settings-panel.active { 
            opacity: 1;
            visibility: visible;
         }
        
        .setting-item.label span {
            font-size: 0.7rem;
            font-weight: 400;
            opacity: 0.7;
            margin-left: 5px;
        }
        
        .settings-panel input[type="number"] {
            background-color: transparent;
            border: none;
            color: var(--primary-color);
            padding: 0;
            width: 40px;
            text-align: center;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 500;
            outline: none;
        }
        input[type=number] { -moz-appearance: textfield; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        #bpm-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 4px;
            background: var(--secondary-color);
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
            border-radius: 2px;
        }
        #bpm-slider:hover { opacity: 1; }
        #bpm-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 18px; height: 18px;
            background: var(--primary-color);
            cursor: pointer;
            border-radius: 50%;
        }
        #bpm-slider::-moz-range-thumb {
            width: 18px; height: 18px;
            background: var(--primary-color);
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }

        /* --- Calculator Panel Styles --- */
        #calc-panel {
            width: 100%;
            max-width: 300px; 
            margin-top: 25px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, margin-top 0.5s ease-in-out;
        }
        #calc-panel.visible {
            max-height: 1000px;
        }
        #calc-view-title {
             margin-bottom: 15px;
        }
        .calc-header-container {
            display: flex;
            border: 2px solid var(--secondary-color);
            overflow: hidden;
            margin-bottom: -2px;
        }
        .calc-header {
            flex: 1;
            padding: 8px;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        #calc-reverb-header {
             background-color: var(--secondary-color);
             color: var(--background-color);
        }

        .calc-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }
        .calc-table th, .calc-table td {
            border: 2px solid var(--secondary-color);
            padding: 4px; 
            text-align: center;
            font-weight: 500;
            font-size: 0.65rem;
        }
        
        #reverb-table thead { background-color: var(--secondary-color); }
        #reverb-table thead th { color: var(--background-color); }

        .calc-table td:first-child {
            font-weight: 600;
            color: var(--primary-color);
            text-align: left;
            padding-left: 8px;
        }
        #global-calc-btn {
            margin-top: 15px;
            width: 100%;
            max-width: 240px;
        }

        /* --- UPDATED: Styles for Delay Table --- */
        #delay-table {
            border-collapse: collapse;
            margin-top: 15px;
        }

        #delay-table caption {
            background-color: var(--accent-color);
            color: var(--background-color);
            padding: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            border: 2px solid var(--accent-color);
            border-bottom: none;
        }
        
        #delay-table,
        #delay-table th,
        #delay-table td {
            border: 2px solid var(--accent-color);
        }

        #delay-table thead th {
            background-color: var(--accent-color);
            color: var(--background-color);
        }

        #delay-table td:first-child {
            font-weight: 700;
            text-align: left;
            padding-left: 8px;
            color: var(--primary-color);
        }
        
        .hidden {
            display: none !important;
        }

    </style>
</head>
<body>
    
    <div id="app-wrapper">
        <!-- RESTORED: Original image icons -->
        <img src="https://www.dropbox.com/scl/fi/5b4motyxla5bkgbk1c3d0/metronome-svgrepo-com.svg?rlkey=w161g2mtryo635255gqooha7z&raw=1" alt="Metronome Icon" class="site-icon-left" id="metronome-icon">
        <img src="https://www.dropbox.com/scl/fi/1m4jb4opjgtxoy6yz2yf0/bell-svgrepo-com.svg?rlkey=8po6w24uqopz056gd5vwk42o2&raw=1" alt="Bell Icon" class="site-icon-left" id="bell-icon">
        <img src="https://www.dropbox.com/scl/fi/y2i8ul09le7i5v03lehma/500.png?rlkey=rbh2kx5rbcgmgowl49ceb9tpv&raw=1" alt="Logo" class="site-logo" id="main-logo" onerror="this.style.display='none'">

        <!-- Timer Module -->
        <div id="timer-module" class="module active">
            <div class="module-container">
                <!-- UPDATED: Added sticky wrapper -->
                <div class="sticky-wrapper">
                    <div class="timer-container">
                        <svg class="timer-svg" viewBox="0 0 100 100">
                            <circle class="timer-circle" id="timer-track" cx="50" cy="50" r="45"></circle>
                            <circle class="timer-circle" id="timer-progress" cx="50" cy="50" r="45"></circle>
                            <g transform="rotate(90, 50, 50)">
                                <circle id="progress-dot" cx="50" cy="5" r="2"></circle>
                            </g>
                        </svg>
                        <div id="time-left" role="timer" aria-live="polite">25:00</div>
                    </div>
                </div>
                <div id="mode-display">Work</div>
                <div class="control-panel">
                    <div class="control-group"><button class="mode-btn" data-mode="pomodoro">Pomodoro</button><button class="mode-btn" data-mode="sports">Sports</button></div>
                    <div id="settings-container">
                        <div id="pomodoro-settings" class="settings-panel">
                            <div class="control-group"><div class="setting-item label">WORK <span>(MIN)</span></div><div class="setting-item"><input type="number" id="work-time" value="25" min="1"></div></div>
                            <div class="control-group"><div class="setting-item label">BREAK <span>(MIN)</span></div><div class="setting-item"><input type="number" id="break-time" value="5" min="1"></div></div>
                        </div>
                        <div id="sports-settings" class="settings-panel">
                            <div class="control-group"><div class="setting-item label">Workout <span>(SEC)</span></div><div class="setting-item"><input type="number" id="workout-time" value="45" min="0"></div></div>
                            <div class="control-group"><div class="setting-item label">Rest <span>(SEC)</span></div><div class="setting-item"><input type="number" id="rest-time" value="15" min="0"></div></div>
                            <div class="control-group"><div class="setting-item label">Rounds</div><div class="setting-item"><input type="number" id="rounds" value="8" min="1"></div></div>
                        </div>
                    </div>
                    <div class="control-group"><button class="control-btn" id="start-pause-btn" role="button">Start</button><button class="control-btn" id="reset-btn" role="button">Reset</button></div>
                </div>
            </div>
        </div>

        <!-- Metronome Module -->
        <div id="metronome-module" class="module">
            <div class="module-container">
                 <!-- UPDATED: Added sticky wrapper -->
                <div class="sticky-wrapper">
                    <div id="metronome-tap-area" class="metronome-display">
                        <div id="bpm-display">135</div>
                        <div id="bpm-label">BPM</div>
                    </div>
                </div>
                <div class="mode-display">Metronome</div>
                <div class="control-panel">
                    <div class="control-group">
                        <button class="control-btn" id="play-stop-metronome" role="button">Play</button>
                    </div>
                    <div class="control-group">
                        <button class="control-btn" id="reset-metronome" role="button">Reset</button>
                        <div class="setting-item" id="bpm-slider-container">
                            <input type="range" min="40" max="220" value="135" id="bpm-slider">
                        </div>
                    </div>
                    <div class="control-group">
                        <button class="control-btn back-button" id="back-to-timer-from-metro" role="button">Back to Timer</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Calculator Panel -->
        <div id="calc-panel">
            <div class="module-container" style="max-width: 300px; padding:0; gap: 0;">
                <div id="calc-view-title">CALCULATOR (<span id="delay-bpm-display">135</span> BPM)</div>
                <table id="delay-table" class="calc-table">
                    <caption>DELAY</caption>
                    <thead>
                        <tr><th>NOTE</th><th>NORMAL</th><th>DOTTED</th><th>TRIPLET</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>1/1</td><td id="t-1-1"></td><td id="t-1-1-d"></td><td id="t-1-1-t"></td></tr>
                        <tr><td>1/2</td><td id="t-1-2"></td><td id="t-1-2-d"></td><td id="t-1-2-t"></td></tr>
                        <tr><td>1/4</td><td id="t-1-4"></td><td id="t-1-4-d"></td><td id="t-1-4-t"></td></tr>
                        <tr><td>1/8</td><td id="t-1-8"></td><td id="t-1-8-d"></td><td id="t-1-8-t"></td></tr>
                        <tr><td>1/16</td><td id="t-1-16"></td><td id="t-1-16-d"></td><td id="t-1-16-t"></td></tr>
                        <tr><td>1/32</td><td id="t-1-32"></td><td id="t-1-32-d"></td><td id="t-1-32-t"></td></tr>
                    </tbody>
                </table>
                 <div class="calc-header-container" style="margin-top:10px; width: 100%;">
                    <div class="calc-header" id="calc-reverb-header">REVERB</div>
                </div>
                <table id="reverb-table" class="calc-table" style="margin-top: -2px;">
                    <thead><tr><th>SIZE</th><th>PREDELAY</th><th>DECAY</th><th>TOTAL</th></tr></thead>
                    <tbody>
                        <tr><td>Hall</td><td id="r-hall-pre"></td><td id="r-hall-decay"></td><td id="r-hall-total"></td></tr>
                        <tr><td>L Room</td><td id="r-lroom-pre"></td><td id="r-lroom-decay"></td><td id="r-lroom-total"></td></tr>
                        <tr><td>S Room</td><td id="r-sroom-pre"></td><td id="r-sroom-decay"></td><td id="r-sroom-total"></td></tr>
                        <tr><td>Ambience</td><td id="r-ambi-pre"></td><td id="r-ambi-decay"></td><td id="r-ambi-total"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    
        <!-- Global Calculator Button -->
        <div class="control-panel" id="global-calc-btn">
            <div class="control-group">
                <button class="control-btn open-calc-btn" role="button" style="flex-basis: 100%; justify-content: center;">Calculators</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const UIElements = {
            appWrapper: document.getElementById('app-wrapper'), // Added for scroll control
            allModules: document.querySelectorAll('.module'),
            timerModule: document.getElementById('timer-module'),
            metronomeModule: document.getElementById('metronome-module'),
            metronomeIcon: document.getElementById('metronome-icon'),
            bellIcon: document.getElementById('bell-icon'),
            mainLogo: document.getElementById('main-logo'),
            backToTimerBtn: document.getElementById('back-to-timer-from-metro'),
            timeLeftDisplay: document.getElementById('time-left'),
            startPauseBtn: document.getElementById('start-pause-btn'),
            resetBtn: document.getElementById('reset-btn'),
            progressCircle: document.getElementById('timer-progress'),
            progressDot: document.getElementById('progress-dot'),
            modeDisplay: document.getElementById('mode-display'),
            modeBtns: document.querySelectorAll('.mode-btn'),
            pomodoroSettings: document.getElementById('pomodoro-settings'),
            sportsSettings: document.getElementById('sports-settings'),
            allTimerInputs: document.querySelectorAll('#timer-module .settings-panel input'),
            bpmDisplay: document.getElementById('bpm-display'),
            bpmSlider: document.getElementById('bpm-slider'),
            playStopMetronomeBtn: document.getElementById('play-stop-metronome'),
            visualBeatIndicator: document.getElementById('metronome-tap-area'),
            resetMetronomeBtn: document.getElementById('reset-metronome'),
            openCalcBtn: document.getElementById('global-calc-btn').querySelector('button'),
            calcPanel: document.getElementById('calc-panel'),
            delayBpmDisplay: document.getElementById('delay-bpm-display'),
        };

        // --- State ---
        const AppState = {
            mainTimerId: null,
            isPaused: true,
            hasStarted: false, 
            currentTimerMode: 'pomodoro',
            targetTime: null,
            pomodoro: {},
            sports: {},
            audioContext: null,
            bpm: 135, // UPDATED: Initial BPM to 135
            isMetronomePlaying: false,
            schedulerTimerID: null,
            beatNumber: 1,
            beatsPerMeasure: 4,
            tapTimestamps: [],
            tapTimeoutId: null,
            isSoundEnabled: true,
            bellEnabledSrc: "https://www.dropbox.com/scl/fi/1m4jb4opjgtxoy6yz2yf0/bell-svgrepo-com.svg?rlkey=8po6w24uqopz056gd5vwk42o2&raw=1",
            bellDisabledSrc: "https://www.dropbox.com/scl/fi/syg6jjwvngtxl1mwk0hdv/bell-disabled-svgrepo-com.svg?rlkey=lrawxg597knm9h8jifkw21ngj&raw=1",
        };

        const radius = UIElements.progressCircle.r.baseVal.value;
        const circumference = 2 * Math.PI * radius;
        UIElements.progressCircle.style.strokeDasharray = circumference;

        // --- Local Storage Functions (Functional Improvement) ---
        const Storage = {
            save: (key, value) => localStorage.setItem(`eyigotyou_${key}`, JSON.stringify(value)),
            get: (key, defaultValue) => {
                const storedValue = localStorage.getItem(`eyigotyou_${key}`);
                return storedValue ? JSON.parse(storedValue) : defaultValue;
            }
        };

        // --- Audio Functions ---
        const Audio = {
            initContext: function() {
                if (!AppState.audioContext) {
                    try {
                        AppState.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    } catch(e) { console.error("Web Audio API is not supported"); }
                }
            },
            playSound: function(frequency) {
                if (!AppState.isSoundEnabled || !AppState.audioContext) return;
                const osc = AppState.audioContext.createOscillator();
                const gain = AppState.audioContext.createGain();
                const toneDuration = 1.0; 
                osc.frequency.value = frequency;
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.5, AppState.audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, AppState.audioContext.currentTime + toneDuration);
                osc.connect(gain);
                gain.connect(AppState.audioContext.destination);
                osc.start(AppState.audioContext.currentTime);
                osc.stop(AppState.audioContext.currentTime + toneDuration);
            }
        };

        // --- UI Update Functions ---
        const UI = {
            showModule: function(moduleToShow) {
                UIElements.allModules.forEach(module => module.classList.remove('active'));
                moduleToShow.classList.add('active');
                const isTimerModule = moduleToShow === UIElements.timerModule;
                
                UIElements.mainLogo.classList.toggle('hidden', !isTimerModule);
                UIElements.metronomeIcon.classList.toggle('hidden', !isTimerModule);
                UIElements.bellIcon.classList.toggle('hidden', !isTimerModule);
            },
            updateTimerDisplay: function(timeLeft, totalDuration) {
                if (totalDuration <= 0) totalDuration = 1;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                UIElements.timeLeftDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const progress = (totalDuration - timeLeft) / totalDuration;
                const isBreak = (AppState.currentTimerMode === 'pomodoro' && AppState.pomodoro.mode === 'break') ||
                              (AppState.currentTimerMode === 'sports' && !AppState.sports.isWorkout);
                
                let strokeColor = 'var(--primary-color)'; // Default color
                if (isBreak) {
                    strokeColor = 'var(--accent-color)';
                } else if (progress >= 0.95) {
                    strokeColor = 'var(--warning-color)'; // Warning color at 95%
                }
                UIElements.progressCircle.style.stroke = strokeColor;
                
                const offset = circumference * (1 - progress);
                UIElements.progressCircle.style.strokeDashoffset = offset;

                // Update dot position
                const angle = progress * 360;
                UIElements.progressDot.parentElement.style.transform = `rotate(${angle-90}deg)`;

            },
            updateCalcTables: function() {
                UIElements.delayBpmDisplay.textContent = AppState.bpm;
                const beatMs = (60 / AppState.bpm) * 1000;
                const noteValues = [4, 2, 1, 0.5, 0.25, 0.125];
                noteValues.forEach((multiplier, index) => {
                    const noteDuration = beatMs * multiplier; const noteId = `1-${Math.pow(2, index)}`;
                    document.getElementById(`t-${noteId}`).textContent = noteDuration.toFixed(2);
                    document.getElementById(`t-${noteId}-d`).textContent = (noteDuration * 1.5).toFixed(2);
                    document.getElementById(`t-${noteId}-t`).textContent = (noteDuration * (2/3)).toFixed(2);
                });
                const reverbConfigs = [
                    { id: 'hall', totalTime: beatMs * 8 }, { id: 'lroom', totalTime: beatMs * 4 },
                    { id: 'sroom', totalTime: beatMs * 2 }, { id: 'ambi', totalTime: beatMs * 1 }
                ];
                reverbConfigs.forEach(config => {
                    const predelay = config.totalTime / 64; const decay = config.totalTime - predelay;
                    document.getElementById(`r-${config.id}-pre`).textContent = predelay.toFixed(2);
                    document.getElementById(`r-${config.id}-decay`).textContent = decay.toFixed(2);
                    document.getElementById(`r-${config.id}-total`).textContent = config.totalTime.toFixed(2);
                });
            }
        };

        // --- Timer Logic ---
        const Timer = {
            resetAll: function() {
                clearInterval(AppState.mainTimerId);
                AppState.mainTimerId = null;
                AppState.targetTime = null;
                AppState.isPaused = true;
                AppState.hasStarted = false;
                UIElements.startPauseBtn.textContent = 'Start';
                UIElements.progressCircle.style.strokeDashoffset = circumference;
                UIElements.progressDot.style.display = 'block';
                if (AppState.currentTimerMode === 'pomodoro') Timer.pomodoroReset();
                if (AppState.currentTimerMode === 'sports') Timer.sportsReset();
            },
            start: function() {
                AppState.isPaused = false; AppState.hasStarted = true; UIElements.startPauseBtn.textContent = 'Pause';
                UIElements.progressDot.style.display = 'none';
                let currentLeft = AppState.currentTimerMode === 'pomodoro' ? AppState.pomodoro.timeLeft : AppState.sports.timeLeft;
                AppState.targetTime = Date.now() + currentLeft * 1000;
                AppState.mainTimerId = setInterval(AppState.currentTimerMode === 'pomodoro' ? Timer.pomodoroTick : Timer.sportsTick, 1000);
            },
            pause: function() {
                 AppState.isPaused = true; UIElements.startPauseBtn.textContent = 'Continue'; clearInterval(AppState.mainTimerId); AppState.mainTimerId = null;
                 UIElements.progressDot.style.display = 'block';
                 if(AppState.targetTime) {
                    const timeLeftOnPause = Math.round((AppState.targetTime - Date.now()) / 1000);
                    const timeToSave = timeLeftOnPause > 0 ? timeLeftOnPause : 0;
                    if (AppState.currentTimerMode === 'pomodoro') AppState.pomodoro.timeLeft = timeToSave;
                    if (AppState.currentTimerMode === 'sports') AppState.sports.timeLeft = timeToSave;
                 }
                 AppState.targetTime = null;
            },
            pomodoroReset: function() {
                const workTimeInput = document.getElementById('work-time');
                const breakTimeInput = document.getElementById('break-time');
                AppState.pomodoro = { 
                    workSec: parseInt(workTimeInput.value, 10) * 60, 
                    breakSec: parseInt(breakTimeInput.value, 10) * 60, 
                    mode: 'work' 
                };
                AppState.pomodoro.timeLeft = AppState.pomodoro.workSec;
                AppState.pomodoro.totalDuration = AppState.pomodoro.workSec;
                UIElements.modeDisplay.textContent = 'Work';
                UI.updateTimerDisplay(AppState.pomodoro.timeLeft, AppState.pomodoro.totalDuration);
            },
            pomodoroSwitch: function() {
                if (AppState.pomodoro.mode === 'work') { Audio.playSound(523.25); } else { Audio.playSound(783.99); }
                AppState.pomodoro.mode = AppState.pomodoro.mode === 'work' ? 'break' : 'work';
                AppState.pomodoro.timeLeft = AppState.pomodoro.mode === 'work' ? AppState.pomodoro.workSec : AppState.pomodoro.breakSec;
                AppState.pomodoro.totalDuration = AppState.pomodoro.timeLeft;
                UIElements.modeDisplay.textContent = AppState.pomodoro.mode === 'work' ? 'Work' : 'Break';
                AppState.targetTime = Date.now() + AppState.pomodoro.timeLeft * 1000;
                UI.updateTimerDisplay(AppState.pomodoro.timeLeft, AppState.pomodoro.totalDuration);
            },
            pomodoroTick: function() {
                let timeLeft = Math.round((AppState.targetTime - Date.now()) / 1000);
                if (timeLeft <= 0) { timeLeft = 0; Timer.pomodoroSwitch(); }
                else { AppState.pomodoro.timeLeft = timeLeft; UI.updateTimerDisplay(timeLeft, AppState.pomodoro.totalDuration); }
            },
            sportsReset: function() {
                AppState.sports = { 
                    workoutSec: parseInt(document.getElementById('workout-time').value, 10), 
                    restSec: parseInt(document.getElementById('rest-time').value, 10), 
                    totalRounds: parseInt(document.getElementById('rounds').value, 10), 
                    currentRound: 1, isWorkout: true, 
                };
                AppState.sports.timeLeft = AppState.sports.workoutSec;
                AppState.sports.totalDuration = AppState.sports.workoutSec;
                UIElements.modeDisplay.textContent = `Round ${AppState.sports.currentRound}`;
                UI.updateTimerDisplay(AppState.sports.timeLeft, AppState.sports.totalDuration);
            },
            sportsSwitch: function() {
                 if (AppState.sports.isWorkout) { Audio.playSound(523.25); AppState.sports.isWorkout = false; AppState.sports.timeLeft = AppState.sports.restSec; UIElements.modeDisplay.textContent = 'Rest'; } 
                 else { Audio.playSound(783.99); AppState.sports.currentRound++;
                    if (AppState.sports.currentRound > AppState.sports.totalRounds) { UIElements.modeDisplay.textContent = 'Complete!'; Timer.resetAll(); return; }
                    AppState.sports.isWorkout = true; AppState.sports.timeLeft = AppState.sports.workoutSec;
                    UIElements.modeDisplay.textContent = `Round ${AppState.sports.currentRound}`;
                 }
                 AppState.sports.totalDuration = AppState.sports.timeLeft;
                 AppState.targetTime = Date.now() + AppState.sports.timeLeft * 1000;
                 UI.updateTimerDisplay(AppState.sports.timeLeft, AppState.sports.totalDuration);
            },
            sportsTick: function() {
                let timeLeft = Math.round((AppState.targetTime - Date.now()) / 1000);
                if (timeLeft <= 0) { timeLeft = 0; Timer.sportsSwitch(); }
                else { AppState.sports.timeLeft = timeLeft; UI.updateTimerDisplay(timeLeft, AppState.sports.totalDuration); }
            }
        };

        // --- Metronome Logic ---
        const Metronome = {
            scheduleTick: function(time, currentBeat) {
                if(!AppState.audioContext) return;
                const osc = AppState.audioContext.createOscillator();
                const gain = AppState.audioContext.createGain();
                osc.frequency.value = (currentBeat === 1) ? 1760 : 880; 
                gain.gain.setValueAtTime(1, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
                osc.connect(gain); gain.connect(AppState.audioContext.destination);
                osc.start(time); osc.stop(time + 0.05);

                setTimeout(() => {
                    if (currentBeat === 1) { UIElements.visualBeatIndicator.style.borderColor = 'var(--accent-color)'; UIElements.visualBeatIndicator.style.transform = 'scale(1.05)'; } 
                    else { UIElements.visualBeatIndicator.style.backgroundColor = 'rgba(255, 255, 255, 0.05)'; }
                    setTimeout(() => { UIElements.visualBeatIndicator.style.borderColor = ''; UIElements.visualBeatIndicator.style.backgroundColor = ''; UIElements.visualBeatIndicator.style.transform = ''; }, 80);
                }, (time - AppState.audioContext.currentTime) * 1000);
            },
            scheduler: function() {
                let nextNoteTime = AppState.audioContext.currentTime; const scheduleAheadTime = 0.1;
                function scheduleLoop() {
                    while (nextNoteTime < AppState.audioContext.currentTime + scheduleAheadTime) {
                        Metronome.scheduleTick(nextNoteTime, AppState.beatNumber); nextNoteTime += 60.0 / AppState.bpm; AppState.beatNumber++;
                        if (AppState.beatNumber > AppState.beatsPerMeasure) { AppState.beatNumber = 1; }
                    }
                }
                AppState.schedulerTimerID = setInterval(scheduleLoop, 25);
            },
            play: function() {
                Audio.initContext(); if(!AppState.audioContext) return;
                if (AppState.audioContext.state === 'suspended') { AppState.audioContext.resume(); }
                AppState.isMetronomePlaying = true; UIElements.playStopMetronomeBtn.textContent = 'Stop'; AppState.beatNumber = 1; Metronome.scheduler();
            },
            stop: function() {
                AppState.isMetronomePlaying = false; UIElements.playStopMetronomeBtn.textContent = 'Play'; clearInterval(AppState.schedulerTimerID);
            },
            reset: function() {
                if (AppState.isMetronomePlaying) { Metronome.stop(); }
                AppState.bpm = 135; // UPDATED: Initial BPM to 135
                UIElements.bpmDisplay.textContent = AppState.bpm; 
                UIElements.bpmSlider.value = AppState.bpm;
                AppState.tapTimestamps = []; clearTimeout(AppState.tapTimeoutId); UI.updateCalcTables();
                Storage.save('bpm', AppState.bpm);
            },
            handleBpmTap: function() {
                const now = Date.now(); clearTimeout(AppState.tapTimeoutId); AppState.tapTimestamps.push(now);
                if (AppState.tapTimestamps.length > 5) { AppState.tapTimestamps.shift(); }
                if (AppState.tapTimestamps.length > 1) {
                    const intervals = [];
                    for (let i = 1; i < AppState.tapTimestamps.length; i++) { intervals.push(AppState.tapTimestamps[i] - AppState.tapTimestamps[i-1]); }
                    const averageInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
                    if (averageInterval > 0) {
                        let newBpm = Math.round(60000 / averageInterval);
                        newBpm = Math.max(40, Math.min(220, newBpm));
                        AppState.bpm = newBpm; UIElements.bpmDisplay.textContent = AppState.bpm; UIElements.bpmSlider.value = AppState.bpm; 
                        UI.updateCalcTables(); Storage.save('bpm', AppState.bpm);
                    }
                }
                AppState.tapTimeoutId = setTimeout(() => { AppState.tapTimestamps = []; }, 2000); 
            }
        };

        // --- Event Listeners & Initializer ---
        function setupEventListeners() {
            UIElements.metronomeIcon.addEventListener('click', () => UI.showModule(UIElements.metronomeModule));
            UIElements.backToTimerBtn.addEventListener('click', () => {
                if (AppState.isMetronomePlaying) Metronome.stop();
                UI.showModule(UIElements.timerModule);
            });
            UIElements.bellIcon.addEventListener('click', () => {
                AppState.isSoundEnabled = !AppState.isSoundEnabled;
                UIElements.bellIcon.src = AppState.isSoundEnabled ? AppState.bellEnabledSrc : AppState.bellDisabledSrc;
                Storage.save('soundEnabled', AppState.isSoundEnabled);
            });
            UIElements.openCalcBtn.addEventListener('click', () => {
                const isVisible = UIElements.calcPanel.classList.toggle('visible');
                UIElements.appWrapper.classList.toggle('is-calculator-open', isVisible);
                UIElements.openCalcBtn.textContent = isVisible ? "Close" : "Calculators";
                if(isVisible) {
                    UI.updateCalcTables();
                }
            });
            UIElements.startPauseBtn.addEventListener('click', () => {
                Audio.initContext();
                if (AppState.isPaused) { if (!AppState.hasStarted) { Timer.resetAll(); } Timer.start(); } 
                else { Timer.pause(); }
            });
            UIElements.resetBtn.addEventListener('click', Timer.resetAll);
            UIElements.allTimerInputs.forEach(input => {
                input.addEventListener('change', () => {
                    if(!AppState.hasStarted) Timer.resetAll();
                    Storage.save('pomodoroWork', document.getElementById('work-time').value);
                    Storage.save('pomodoroBreak', document.getElementById('break-time').value);
                    Storage.save('sportsWorkout', document.getElementById('workout-time').value);
                    Storage.save('sportsRest', document.getElementById('rest-time').value);
                    Storage.save('sportsRounds', document.getElementById('rounds').value);
                });
            });
            UIElements.modeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const mode = btn.dataset.mode;
                    if (mode === AppState.currentTimerMode) return;
                    AppState.currentTimerMode = mode;
                    Storage.save('timerMode', mode);
                    UIElements.modeBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    UIElements.pomodoroSettings.classList.toggle('active', mode === 'pomodoro');
                    UIElements.sportsSettings.classList.toggle('active', mode === 'sports');
                    Timer.resetAll();
                });
            });
            UIElements.playStopMetronomeBtn.addEventListener('click', () => { AppState.isMetronomePlaying ? Metronome.stop() : Metronome.play(); });
            UIElements.bpmSlider.addEventListener('input', (e) => { 
                AppState.bpm = e.target.value; 
                UIElements.bpmDisplay.textContent = AppState.bpm; 
                UI.updateCalcTables(); 
            });
            UIElements.bpmSlider.addEventListener('change', () => Storage.save('bpm', AppState.bpm));
            UIElements.visualBeatIndicator.addEventListener('click', Metronome.handleBpmTap);
            UIElements.resetMetronomeBtn.addEventListener('click', Metronome.reset);
        }

        function initializeApp() {
            document.getElementById('work-time').value = Storage.get('pomodoroWork', 25);
            document.getElementById('break-time').value = Storage.get('pomodoroBreak', 5);
            document.getElementById('workout-time').value = Storage.get('sportsWorkout', 45);
            document.getElementById('rest-time').value = Storage.get('sportsRest', 15);
            document.getElementById('rounds').value = Storage.get('sportsRounds', 8);
            
            AppState.currentTimerMode = Storage.get('timerMode', 'pomodoro');
            UIElements.modeBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === AppState.currentTimerMode);
            });
            UIElements.pomodoroSettings.classList.toggle('active', AppState.currentTimerMode === 'pomodoro');
            UIElements.sportsSettings.classList.toggle('active', AppState.currentTimerMode === 'sports');

            AppState.bpm = Storage.get('bpm', 135);
            UIElements.bpmDisplay.textContent = AppState.bpm;
            UIElements.bpmSlider.value = AppState.bpm;

            AppState.isSoundEnabled = Storage.get('soundEnabled', true);
            UIElements.bellIcon.src = AppState.isSoundEnabled ? AppState.bellEnabledSrc : AppState.bellDisabledSrc;

            setupEventListeners();
            UI.showModule(UIElements.timerModule)
            Timer.resetAll();
            UI.updateCalcTables();
        }

        initializeApp();
    });
    </script>
</body>
</html>
