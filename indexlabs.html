<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EYIGOTYOU LABS</title>
    <link rel="icon" type="image/jpeg" href="https://www.dropbox.com/scl/fi/n2ez50rho6xydpma93sq2/500.jpeg?rlkey=8omntfna9sqvagk8p6cs7gjwh&raw=1" onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>E</text></svg>'">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-color: #0A0A0A;
            --primary-color: #FFFFFF;
            --secondary-color: #888888;
            --accent-color: #1E8449; /* Green for activated */
            --warning-color: #EF4444; /* Red for deactivated/overtime */
            --sidequest-color: #F54291; /* Pink */
            --personal-color: #4A90E2; /* Blue */
            --break-color: #1E8449; /* Green for breaks */
        }

        html, body {
            height: 100%;
            margin: 0;
            background-color: var(--background-color);
            color: var(--secondary-color);
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            overflow: hidden; 
            overflow-x: hidden; 
        }

        #app-wrapper {
             display: flex;
             flex-direction: column;
             align-items: center;
             width: 100%;
             height: 100%;
             max-height: 100%;
             overflow-y: hidden;
             box-sizing: border-box;
        }

        #app-wrapper.is-panel-open {
            overflow-y: auto;
        }
        
        /* --- Corner Icons --- */
        #logo-container {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .site-logo-img {
            width: 45px;
            height: auto;
            transition: transform 0.2s ease;
        }

        #logo-container:hover .site-logo-img {
            transform: scale(1.1);
        }
        
        #labs-indicator {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 0.6rem;
            color: var(--secondary-color);
            margin-top: 4px;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .site-icon-left {
            position: fixed;
            width: 32px;
            height: auto;
            z-index: 100;
            filter: invert(1) opacity(0.6);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        
        .site-icon-left:hover {
            transform: scale(1.1);
            filter: invert(1) opacity(1);
        }
        
        #menu-icon { 
            top: 15px; 
            left: 15px; 
            z-index: 101; 
            fill: #888888;
        }
        #menu-icon:hover {
            fill: #FFFFFF;
        }
        
        /* Icon Positioning */
        #bell-icon { top: 15px; left: 60px; }
        #notepad-icon { top: 15px; left: 105px; width: 38px;}
        #gps-icon { top: 65px; left: 15px; } /* Vertical Position */


        /* Flyout Menu Logic */
        #left-icon-menu .site-icon-left:not(#menu-icon) {
            opacity: 0;
            visibility: hidden;
            transform: translateX(-20px);
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
        }
        #left-icon-menu.menu-open .site-icon-left:not(#menu-icon) {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }

        #left-icon-menu.menu-open .site-icon-left:nth-child(2) { transition-delay: 0.05s; }
        #left-icon-menu.menu-open .site-icon-left:nth-child(3) { transition-delay: 0.1s; }
        #left-icon-menu.menu-open .site-icon-left:nth-child(4) { transition-delay: 0.15s; }
        
        /* --- Layout Structure --- */
        .sticky-wrapper {
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: var(--background-color);
            padding-top: 5vh; 
            padding-bottom: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .scrollable-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            padding: 0 15px 20px 15px;
            box-sizing: border-box;
        }

        .module-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 100%;
            max-width: 240px;
        }

        .sticky-display {
            display: flex;
            height: 100%;
            width: 100%;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        /* --- Generic Modal Styles --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 10, 0.95); z-index: 200;
            display: none; justify-content: center; align-items: center;
            padding: 20px; box-sizing: border-box;
            opacity: 0; transition: opacity 0.3s ease-in-out;
        }
        .modal-overlay.active, .modal-overlay.visible {
            display: flex; opacity: 1;
        }
        .modal-content {
            position: relative;
            color: var(--primary-color);
            max-width: 420px;
            width: 100%;
            text-align: left;
        }
        .close-modal-btn {
            position: absolute; top: 5px; right: 10px;
            font-size: 1.75rem; color: var(--secondary-color);
            background: none; border: none; cursor: pointer; line-height: 1;
        }
        .close-modal-btn:hover { color: var(--primary-color); }

        #donate-content {
             font-size: 0.9rem;
             line-height: 1.6;
        }

        #donate-intro-text p {
            margin: 0 0 1em 0;
            color: var(--secondary-color);
            min-height: 1.6em;
        }
        .typing-cursor {
            border-right: .15em solid var(--accent-color);
            animation: blink-caret .75s step-end infinite;
        }
        @keyframes blink-caret {
          from, to { border-color: transparent }
          50% { border-color: var(--accent-color); }
        }

        #kofi-container {
            border: 2px solid #2a2a2a; padding: 4px;
            background: #121212; border-radius: 8px;
            overflow: hidden; margin-top: 20px;
        }

        #exit-labs-btn-container { margin-top: 20px; width: 100%; }
        #exit-labs-btn-container .control-btn { justify-content: center; }

        /* --- Timer Specific --- */
        .timer-container {
            position: relative;
            width: 65vw; height: 65vw;
            max-width: 240px; max-height: 240px;
            display: flex; justify-content: center; align-items: center;
            cursor: default;
        }

        .timer-svg {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; transform: rotate(-90deg);
        }

        .timer-circle { fill: none; stroke-width: 4; }
        #timer-track { stroke: var(--secondary-color); opacity: 0.1; }
        #timer-progress {
            stroke: var(--primary-color); stroke-linecap: round;
            transition: stroke 0.5s ease-in-out, stroke-dashoffset 0.2s linear;
        }
        #timer-progress.sidequest { animation: pulse-sidequest 2s infinite alternate ease-in-out; }
        #timer-progress.personal { animation: pulse-personal 2s infinite alternate ease-in-out; }

        @keyframes pulse-sidequest {
            from { stroke: var(--secondary-color); }
            to { stroke: var(--sidequest-color); }
        }
        @keyframes pulse-personal {
            from { stroke: var(--secondary-color); }
            to { stroke: var(--personal-color); }
        }

        #progress-dot {
            fill: var(--primary-color); transition: fill 0.5s ease-in-out;
        }
        
        #time-left {
            z-index: 1; font-size: clamp(2rem, 10vw, 3rem); 
            font-weight: 700; letter-spacing: 0.1em; color: var(--primary-color);
        }
        
        #mode-display, #notepad-title, #soft-tracking-title, #todo-title, #active-session-title {
            z-index: 2; font-size: 0.7rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.2em;
            color: var(--secondary-color); text-align: center;
            height: 1em; margin-bottom: 15px;
        }
        
        #mode-display { cursor: pointer; transition: color 0.5s ease-in-out; }
        
        /* New Inline Controls for Overtime */
        #inline-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            width: 100%;
            max-width: 240px;
        }

        .inline-btn {
             background-color: transparent;
             border: 2px solid var(--secondary-color);
             color: var(--secondary-color);
             padding: 6px 12px;
             font-family: 'Inter', sans-serif;
             font-size: 0.7rem;
             font-weight: 600;
             text-transform: uppercase;
             cursor: pointer;
             transition: all 0.2s ease-in-out;
        }
        .inline-btn:hover {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }


        @keyframes blink-green { 50% { color: var(--accent-color); } }
        @keyframes blink-red { 50% { color: var(--warning-color); } }

        .tracking-activated-animation { color: var(--secondary-color); animation: blink-green 0.5s linear 5; }
        .tracking-deactivated-animation { color: var(--secondary-color); animation: blink-red 0.5s linear 5; }

        /* --- Notepad & Soft Tracking Panels --- */
        #notepad-panel, #soft-tracking-panel { width: 100%; }
        #notepad-panel .control-panel, #soft-tracking-panel .control-panel { max-width: 100%; }
        #notepad-textarea {
            width: 100%; background: rgba(255,255,255,0.05);
            border: 2px solid var(--secondary-color); color: var(--primary-color);
            border-radius: 0; padding: 8px; font-family: 'Inter', sans-serif;
            resize: vertical; min-height: 120px; box-sizing: border-box; margin-bottom: 10px;
        }
        #notepad-textarea:focus { outline: none; border-color: var(--primary-color); }

        /* --- Generic Controls --- */
        .control-panel { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .control-group { display: flex; border: 2px solid var(--secondary-color); overflow: hidden; }
        .control-btn, .setting-item {
            background-color: transparent; border: none; color: var(--secondary-color); padding: 8px;
            font-family: 'Inter', sans-serif; font-size: 0.8rem; font-weight: 600;
            text-transform: uppercase; transition: all 0.2s ease-in-out;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            cursor: pointer; flex: 1;
        }
        .control-group > *:not(:last-child) { border-right: 2px solid var(--secondary-color); }
        .control-btn:hover { color: var(--primary-color); }
        .control-btn.sidequest-btn:hover { color: var(--sidequest-color); }
        .control-btn.personal-btn:hover { color: var(--personal-color); }
        #start-stop-btn, .setting-item.label { flex-grow: 1.5; justify-content: flex-start; padding-left: 15px; }
        #options-btn, #reset-btn { flex-grow: 1; }
        .setting-item.label { cursor: pointer; }
        #settings-container { position: relative; height: 80px; }
        .options-wrapper {
            display: flex; flex-direction: column; gap: 10px; width: 100%;
            overflow: hidden; transition: max-height 0.5s ease-in-out, gap 0.5s ease-in-out;
        }
        .options-wrapper.hidden { max-height: 0; gap: 0; }
        .settings-panel { display: flex; flex-direction: column; gap: 10px; }
        .setting-item.label span { font-size: 0.7rem; font-weight: 400; opacity: 0.7; margin-left: 5px; }
        .settings-panel input[type="number"] {
            background-color: transparent; border: none; color: var(--primary-color);
            padding: 0; width: 40px; text-align: center; font-family: inherit;
            font-size: 0.8rem; font-weight: 500; outline: none;
        }
        input[type=number] { -moz-appearance: textfield; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        .collapsible-panel {
            width: 100%; margin-top: 15px; max-height: 0;
            overflow: hidden; transition: max-height 0.5s ease-in-out, margin-top 0.5s ease-in-out;
        }
        .collapsible-panel.visible { max-height: 1000px; }
        
        /* --- Task & Session Modals --- */
        .task-modal-content {
            background: var(--background-color); border: 2px solid var(--secondary-color);
            padding: 20px; width: 90%; max-width: 350px;
            display: flex; flex-direction: column; gap: 15px;
        }
        .task-modal-content h3 {
            margin: 0; font-size: 1rem; color: var(--primary-color); text-align: center;
            text-transform: uppercase; letter-spacing: 0.1em; padding-top: 5px;
        }
        .modal-input {
            width: 100%; background: rgba(255,255,255,0.05);
            border: 2px solid var(--secondary-color); color: var(--primary-color);
            padding: 8px; font-family: 'Inter', sans-serif; box-sizing: border-box;
        }
        .modal-input:focus { outline: none; border-color: var(--primary-color); }
        #task-modal-list, #task-modal-end-session-list, #session-list { max-height: 150px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        .task-modal-item, .session-list-item {
            padding: 8px; border: 1px solid var(--secondary-color); cursor: pointer;
            font-size: 0.8rem; transition: background-color 0.2s, border-color 0.2s;
        }
        .task-modal-item:hover, .session-list-item:hover { background-color: rgba(255,255,255,0.1); }
        .session-list-item.active { border-color: var(--accent-color); color: var(--accent-color); }
        .end-session-item, .export-option-item { display: flex; align-items: center; gap: 10px; font-size: 0.9rem;}
        .end-session-item input[type="checkbox"], .export-option-item input[type="checkbox"] { width: 18px; height: 18px; }

        /* --- Soft Tracking Panel --- */
        #todo-list, #session-log-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 8px; }
        .task-list-item { display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem; }
        .task-list-item .task-content { display: flex; align-items: center; gap: 10px; overflow: hidden; }
        .task-list-item label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .task-list-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; flex-shrink: 0; }
        .task-list-item label.completed { text-decoration: line-through; color: var(--secondary-color); }
        .delete-task-btn { background: none; border: none; color: var(--secondary-color); font-size: 1.2rem; cursor: pointer; padding: 0 5px; line-height: 1; flex-shrink: 0;}
        .delete-task-btn:hover { color: var(--warning-color); }
        .session-log-entry { margin-bottom: 10px; font-size: 0.8rem; }
        .session-log-entry .log-header { font-weight: 600; color: var(--accent-color); }
        .session-log-entry .log-header.break { color: var(--break-color); }
        .session-log-entry .log-header.sidequest { color: var(--sidequest-color); }
        .session-log-entry .log-header.personal { color: var(--personal-color); }
        .session-log-entry .log-header.overtime { color: var(--warning-color); } /* Red for Overtime */
        .session-log-entry .log-task-list { list-style-type: ' - '; padding-left: 20px; color: var(--primary-color); }
        .session-log-entry .log-task-list .task-status { color: var(--secondary-color); font-style: italic; margin-left: 5px;}
        
        #active-session-display {
            font-size: 0.8rem;
            color: var(--primary-color);
            background: rgba(255,255,255,0.05);
            padding: 5px 10px;
            margin-bottom: 10px;
            width: 100%;
            text-align: center;
            box-sizing: border-box;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    
    <div id="app-wrapper">
        <div id="left-icon-menu">
            <svg id="menu-icon" class="site-icon-left" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 6h16M4 12h16M4 18h16" stroke="#888888" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="stroke: var(--secondary-color); transition: stroke 0.2s ease-in-out;"></path>
            </svg>
            <img src="https://www.dropbox.com/scl/fi/1m4jb4opjgtxoy6yz2yf0/bell-svgrepo-com.svg?rlkey=8po6w24uqopz056gd5vwk42o2&raw=1" alt="Bell Icon" class="site-icon-left" id="bell-icon">
            <img src="https://www.dropbox.com/scl/fi/1uvselpcovxwl1ahvdhjz/notes-svgrepo-com.svg?rlkey=eidktq0vfjc2ss4kuw2252hl1&raw=1" alt="Notepad Icon" class="site-icon-left" id="notepad-icon">
            <img src="https://www.dropbox.com/scl/fi/08zzq0ooqehz59j45phq1/gps-location-svgrepo-com.svg?rlkey=fr4muh7spzzjrjfe0dm2eo7i8&raw=1" alt="GPS Icon" class="site-icon-left" id="gps-icon">
        </div>

        <div id="logo-container">
            <img src="https://www.dropbox.com/scl/fi/y2i8ul09le7i5v03lehma/500.png?rlkey=rbh2kx5rbcgmgowl49ceb9tpv&raw=1" alt="Logo" class="site-logo-img" onerror="this.style.display='none'">
            <div id="labs-indicator">[LABS]</div>
        </div>


        <div id="donate-overlay" class="modal-overlay">
            <div id="donate-content" class="modal-content">
                <button class="close-modal-btn">&times;</button>
                <div id="donate-intro-text">
                    <p id="donate-line-1"></p>
                    <p id="donate-line-2"></p>
                </div>
                 <div id="kofi-container">
                    <iframe id='kofiframe' src='https://ko-fi.com/konstantinsonnenkind/?hidefeed=true&widget=true&embed=true&preview=true&theme=dark' style='border:none;width:100%;' height='712' title='konstantinsonnenkind'></iframe>
                </div>
                <div id="exit-labs-btn-container">
                    <button class="control-btn" id="exit-labs-btn">[EXIT LABS]</button>
                </div>
            </div>
        </div>
        
        <!-- Main Task Modal -->
        <div id="task-modal-overlay" class="modal-overlay">
            <div id="task-modal" class="task-modal-content modal-content">
                <button class="close-modal-btn">&times;</button>
                <div id="task-modal-new-task-view">
                    <h3>What will you work on?</h3>
                    <input type="text" id="task-modal-input" class="modal-input" placeholder="Enter a new task...">
                    <div id="task-modal-list"></div>
                    <div class="control-group">
                         <button class="control-btn" id="task-modal-start-btn">Start Session</button>
                    </div>
                </div>
                <div id="task-modal-end-session-view" class="hidden">
                    <h3>What did you finish?</h3>
                    <div id="task-modal-end-session-list"></div>
                     <div class="control-group">
                        <button class="control-btn" id="task-modal-confirm-btn">Confirm & Finish</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Task Modal -->
        <div id="add-task-prompt-overlay" class="modal-overlay">
            <div id="add-task-prompt" class="task-modal-content modal-content">
                 <button class="close-modal-btn">&times;</button>
                 <h3>Add New Task</h3>
                 <input type="text" id="add-task-prompt-input" class="modal-input" placeholder="Task description...">
                 <div class="control-group">
                    <button class="control-btn" id="add-task-prompt-confirm-btn">Add Task</button>
                 </div>
            </div>
        </div>

        <!-- Session Management Modal -->
        <div id="session-management-overlay" class="modal-overlay">
            <div id="session-management-content" class="task-modal-content modal-content">
                 <button class="close-modal-btn">&times;</button>
                 <h3>Session Management</h3>
                 <input type="text" id="session-name-input" class="modal-input" placeholder="New session name...">
                 <div class="control-group">
                    <button class="control-btn" id="create-session-btn">Create & Switch</button>
                 </div>
                 <hr style="width:100%; border-color:var(--secondary-color); margin: 5px 0;">
                 <h4 style="text-align: center; margin: 0;">Open Sessions</h4>
                 <div id="session-list"></div>
                 <hr style="width:100%; border-color:var(--secondary-color); margin: 5px 0;">
                 <div class="control-group">
                    <button class="control-btn" id="end-session-btn">End Current Session</button>
                 </div>
            </div>
        </div>
        
        <!-- Export Session Modal -->
        <div id="export-session-overlay" class="modal-overlay">
            <div id="export-session-content" class="task-modal-content modal-content">
                 <button class="close-modal-btn">&times;</button>
                 <h3>End Session?</h3>
                 <p style="text-align: center; font-size: 0.9rem; line-height: 1.5;">Would you like to save this session log before ending it?</p>
                 <div class="export-option-item">
                    <input type="checkbox" id="include-sidequest-time">
                    <label for="include-sidequest-time">Include Sidequest Time</label>
                 </div>
                 <div class="export-option-item">
                    <input type="checkbox" id="include-personal-time">
                    <label for="include-personal-time">Include Personal Time</label>
                 </div>
                 <div class="control-group" style="margin-top: 10px;">
                    <button class="control-btn" id="save-session-txt-btn">Save as .txt</button>
                    <button class="control-btn" id="copy-session-notepad-btn">Copy to Notepad</button>
                 </div>
                 <button class="control-btn" id="end-session-anyway-btn" style="border: 2px solid var(--secondary-color); margin-top: 5px;">Just End Session</button>
            </div>
        </div>

        <div class="sticky-wrapper">
            <div id="timer-display-sticky" class="sticky-display">
                <div class="timer-container">
                    <svg class="timer-svg" viewBox="0 0 100 100">
                        <circle class="timer-circle" id="timer-track" cx="50" cy="50" r="45"></circle>
                        <circle class="timer-circle" id="timer-progress" cx="50" cy="50" r="45"></circle>
                        <g transform="rotate(90, 50, 50)">
                            <circle id="progress-dot" cx="50" cy="5" r="2"></circle>
                        </g>
                    </svg>
                    <div id="time-left" role="timer" aria-live="polite">25:00</div>
                </div>
            </div>
        </div>

        <div class="scrollable-content">
            <div id="timer-controls" class="module-controls">
                <div id="mode-display">Work</div>
                <div id="active-session-display" class="hidden"></div>
                 <div id="inline-controls" class="hidden">
                    <button class="inline-btn" id="extend-time-btn">+5 Min</button>
                    <button class="inline-btn" id="start-break-btn">Start Break</button>
                </div>
                <div class="control-panel">
                    <div id="timer-options-wrapper" class="options-wrapper">
                        <div id="settings-container">
                            <div id="pomodoro-settings" class="settings-panel">
                                <div class="control-group"><div class="setting-item label" data-start-mode="work">WORK <span>(MIN)</span></div><div class="setting-item"><input type="number" id="work-time" value="25" min="1"></div></div>
                                <div class="control-group"><div class="setting-item label" data-start-mode="break">BREAK <span>(MIN)</span></div><div class="setting-item"><input type="number" id="break-time" value="5" min="1"></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="control-group">
                        <button class="control-btn" id="start-stop-btn">Start</button>
                        <button class="control-btn hidden" id="options-btn">Options</button>
                        <button class="control-btn" id="reset-btn">Reset</button>
                    </div>
                    <div id="special-pause-controls" class="control-group hidden">
                        <button class="control-btn sidequest-btn" id="sidequest-btn">SIDEQUEST</button>
                        <button class="control-btn personal-btn" id="personal-btn">PERSONAL</button>
                    </div>
                </div>
            </div>
            
            <div id="soft-tracking-panel" class="collapsible-panel module-controls">
                <div id="soft-tracking-title">Session Log</div>
                <div class="control-panel">
                    <ul id="session-log-list"></ul>
                    <hr style="width:100%; border-color:var(--secondary-color); margin: 10px 0;">
                    <div id="todo-title">To Do</div>
                    <ul id="todo-list"></ul>
                    <div class="control-group">
                        <button class="control-btn" id="add-task-btn">Add Task</button>
                    </div>
                </div>
            </div>

            <div id="notepad-panel" class="collapsible-panel module-controls">
                <div id="notepad-title">Notepad</div>
                 <div class="control-panel">
                    <textarea id="notepad-textarea" placeholder="Add and save your notes here..."></textarea>
                    <div class="control-group">
                        <button class="control-btn" id="copy-notes-btn">Copy</button>
                        <button class="control-btn" id="clear-notes-btn">Clear</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const UIElements = {
            appWrapper: document.getElementById('app-wrapper'),
            leftIconMenu: document.getElementById('left-icon-menu'),
            menuIcon: document.getElementById('menu-icon'),
            bellIcon: document.getElementById('bell-icon'),
            notepadIcon: document.getElementById('notepad-icon'),
            gpsIcon: document.getElementById('gps-icon'),
            logoContainer: document.getElementById('logo-container'),
            donateOverlay: document.getElementById('donate-overlay'),
            exitLabsBtn: document.getElementById('exit-labs-btn'),
            timeLeftDisplay: document.getElementById('time-left'),
            startStopBtn: document.getElementById('start-stop-btn'),
            optionsBtn: document.getElementById('options-btn'),
            resetBtn: document.getElementById('reset-btn'),
            specialPauseControls: document.getElementById('special-pause-controls'),
            sidequestBtn: document.getElementById('sidequest-btn'),
            personalBtn: document.getElementById('personal-btn'),
            progressCircle: document.getElementById('timer-progress'),
            progressDot: document.getElementById('progress-dot'),
            modeDisplay: document.getElementById('mode-display'),
            workTimeInput: document.getElementById('work-time'),
            breakTimeInput: document.getElementById('break-time'),
            timerOptionsWrapper: document.getElementById('timer-options-wrapper'), 
            notepadPanel: document.getElementById('notepad-panel'),
            notepadTextarea: document.getElementById('notepad-textarea'),
            copyNotesBtn: document.getElementById('copy-notes-btn'),
            clearNotesBtn: document.getElementById('clear-notes-btn'),
            softTrackingPanel: document.getElementById('soft-tracking-panel'),
            activeSessionDisplay: document.getElementById('active-session-display'),
            taskModalOverlay: document.getElementById('task-modal-overlay'),
            taskModalNewTaskView: document.getElementById('task-modal-new-task-view'),
            taskModalEndSessionView: document.getElementById('task-modal-end-session-view'),
            taskModalInput: document.getElementById('task-modal-input'),
            taskModalList: document.getElementById('task-modal-list'),
            taskModalEndSessionList: document.getElementById('task-modal-end-session-list'),
            taskModalStartBtn: document.getElementById('task-modal-start-btn'),
            taskModalConfirmBtn: document.getElementById('task-modal-confirm-btn'),
            todoList: document.getElementById('todo-list'),
            sessionLogList: document.getElementById('session-log-list'),
            addTaskBtn: document.getElementById('add-task-btn'),
            addTaskPromptOverlay: document.getElementById('add-task-prompt-overlay'),
            addTaskPromptInput: document.getElementById('add-task-prompt-input'),
            addTaskPromptConfirmBtn: document.getElementById('add-task-prompt-confirm-btn'),
            closeModalBtns: document.querySelectorAll('.close-modal-btn'),
            sessionManagementOverlay: document.getElementById('session-management-overlay'),
            sessionNameInput: document.getElementById('session-name-input'),
            createSessionBtn: document.getElementById('create-session-btn'),
            sessionList: document.getElementById('session-list'),
            endSessionBtn: document.getElementById('end-session-btn'),
            exportSessionOverlay: document.getElementById('export-session-overlay'),
            saveSessionTxtBtn: document.getElementById('save-session-txt-btn'),
            copySessionToNotepadBtn: document.getElementById('copy-session-notepad-btn'),
            endSessionAnywayBtn: document.getElementById('end-session-anyway-btn'),
            includeSidequestTime: document.getElementById('include-sidequest-time'),
            includePersonalTime: document.getElementById('include-personal-time'),
            inlineControls: document.getElementById('inline-controls'),
            extendTimeBtn: document.getElementById('extend-time-btn'),
            startBreakBtn: document.getElementById('start-break-btn'),
        };

        // --- App State ---
        const AppState = {
            mainTimerId: null, 
            workFinishedTimeoutId: null,
            timeLeft: 0,
            totalDuration: 0,
            targetTime: 0,
            timerPhase: 'IDLE', // IDLE, WORK_RUNNING, WORK_FINISHED, WORK_OVERTIME, BREAK_RUNNING, BREAK_FINISHED, LOGGING_EARLY
            preLogPhase: null, // Stores the phase before showing the log modal early
            audioContext: null, isSoundEnabled: true,
            isSoftTrackingActive: false,
            initialMode: 'work',
            bellEnabledSrc: "https://www.dropbox.com/scl/fi/1m4jb4opjgtxoy6yz2yf0/bell-svgrepo-com.svg?rlkey=8po6w24uqopz056gd5vwk42o2&raw=1",
            bellDisabledSrc: "https://www.dropbox.com/scl/fi/syg6jjwvngtxl1mwk0hdv/bell-disabled-svgrepo-com.svg?rlkey=lrawxg597knm9h8jifkw21ngj&raw=1",
            typewriterTimeout: null,
            sessions: {},
            activeSessionId: null,
            currentTask: null,
            newlyCompletedTasks: new Set(),
            specialPause: {
                mode: null,
                timerId: null,
                overallStartTime: null,
                currentModeStartTime: null
            },
            completedWorkDuration: 0,
            overtimeDuration: 0 
        };

        const radius = UIElements.progressCircle.r.baseVal.value;
        const circumference = 2 * Math.PI * radius;
        UIElements.progressCircle.style.strokeDasharray = circumference;

        const Storage = {
            save: (key, value) => {
                if (value instanceof Set) { value = Array.from(value); }
                localStorage.setItem(`eyigotyou_labs_${key}`, JSON.stringify(value));
            },
            get: (key, defaultValue) => {
                const storedValue = localStorage.getItem(`eyigotyou_labs_${key}`);
                return storedValue ? JSON.parse(storedValue) : defaultValue;
            }
        };
        
        const formatDuration = (seconds) => {
            const roundedSeconds = Math.round(seconds);
            if (roundedSeconds < 60) {
                return `${roundedSeconds}s`;
            }
            if (roundedSeconds < 3600) {
                const minutes = Math.floor(roundedSeconds / 60);
                const secs = roundedSeconds % 60;
                return `${minutes}m ${secs}s`;
            }
            const hours = Math.floor(roundedSeconds / 3600);
            const minutes = Math.floor((roundedSeconds % 3600) / 60);
            return `${hours}h ${minutes.toString().padStart(2, '0')}m`;
        };

        const Audio = {
            initContext: function() { if (!AppState.audioContext) { try { AppState.audioContext = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { console.error("Web Audio API is not supported"); } } },
            playSound: function(frequency, duration = 1.0) {
                if (!AppState.isSoundEnabled || !AppState.audioContext) return;
                const osc = AppState.audioContext.createOscillator(); const gain = AppState.audioContext.createGain();
                osc.frequency.value = frequency; osc.type = 'sine';
                gain.gain.setValueAtTime(0.5, AppState.audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, AppState.audioContext.currentTime + duration);
                osc.connect(gain); gain.connect(AppState.audioContext.destination);
                osc.start(AppState.audioContext.currentTime); osc.stop(AppState.audioContext.currentTime + duration);
            }
        };

        const UI = {
            updateTimerDisplay: function(timeLeft, totalDuration) {
                if (totalDuration <= 0) totalDuration = 1;
                 const roundedTimeLeft = Math.max(0, Math.round(timeLeft));
                const minutes = Math.floor(roundedTimeLeft / 60); const seconds = roundedTimeLeft % 60;
                UIElements.timeLeftDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                UIElements.progressCircle.classList.remove('sidequest', 'personal');
                UIElements.progressCircle.style.animation = 'none';
                UIElements.progressCircle.style.stroke = '';
                UIElements.progressDot.style.display = 'block';

                if (AppState.specialPause.mode) {
                    UIElements.progressCircle.classList.add(AppState.specialPause.mode);
                    UIElements.progressCircle.style.animation = AppState.specialPause.mode === 'sidequest' 
                        ? 'pulse-sidequest 2s infinite alternate ease-in-out'
                        : 'pulse-personal 2s infinite alternate ease-in-out';
                    UIElements.progressCircle.style.strokeDashoffset = 0;
                    UIElements.progressDot.style.display = 'none';
                } else {
                    const progress = (totalDuration - timeLeft) / totalDuration;
                    const isBreak = AppState.timerPhase.includes('BREAK');
                    const isOvertime = AppState.timerPhase === 'WORK_OVERTIME';

                    let strokeColor;
                    if (isOvertime) {
                        strokeColor = 'var(--warning-color)'; // Force red for overtime
                    } else {
                        strokeColor = isBreak ? 'var(--break-color)' : 'var(--primary-color)';
                        if (!isBreak && progress >= 0.95) { strokeColor = 'var(--warning-color)'; }
                    }
                    UIElements.progressCircle.style.stroke = strokeColor;

                    const offset = circumference * (1 - progress);
                    UIElements.progressCircle.style.strokeDashoffset = offset;
                    
                    const angle = progress * 360;
                    UIElements.progressDot.parentElement.style.transform = `rotate(${angle-90}deg)`;
                    if(AppState.timerPhase.includes('PAUSED') || AppState.timerPhase === 'IDLE' || AppState.timerPhase === 'WORK_FINISHED') {
                         UIElements.progressDot.style.display = 'block';
                    } else {
                         UIElements.progressDot.style.display = 'none';
                    }
                }
            },
            typewriter: function(element, text, speed, onComplete = () => {}) {
                let i = 0; element.innerHTML = ''; 
                function type() {
                    if (i < text.length) {
                        element.innerHTML = text.substring(0, i + 1) + '<span class="typing-cursor"></span>';
                        i++; AppState.typewriterTimeout = setTimeout(type, speed);
                    } else { element.innerHTML = text; onComplete(); }
                }
                type();
            },
            toggleDonateOverlay: function(show) {
                 UIElements.donateOverlay.classList.toggle('active', show);
                 const line1 = document.getElementById('donate-line-1');
                 const line2 = document.getElementById('donate-line-2');
                 clearTimeout(AppState.typewriterTimeout); line1.innerHTML = ''; line2.innerHTML = '';
                 if(show) {
                    UIElements.logoContainer.classList.add('hidden');
                    const text1 = "Dear Supporters,";
                    const text2 = "This app was built with love to keep things simple, focused, and free. If you find it useful and want to help keep it alive, please consider a small donation.";
                    this.typewriter(line1, text1, 50, () => { this.typewriter(line2, text2, 30); });
                 } else { UIElements.logoContainer.classList.remove('hidden'); }
            },
            renderActiveSessionData: function() {
                if (!AppState.activeSessionId || !AppState.sessions[AppState.activeSessionId]) {
                    UIElements.todoList.innerHTML = '';
                    UIElements.sessionLogList.innerHTML = '';
                    UIElements.activeSessionDisplay.classList.add('hidden');
                    return;
                }
                const activeSession = AppState.sessions[AppState.activeSessionId];
                UIElements.todoList.innerHTML = '';
                activeSession.todoTasks.forEach((task, index) => {
                    const li = document.createElement('li');
                    li.className = 'task-list-item';
                    li.innerHTML = `
                        <div class="task-content">
                            <input type="checkbox" id="task-${index}" ${task.completed ? 'checked' : ''} data-index="${index}">
                            <label for="task-${index}" class="${task.completed ? 'completed' : ''}">${task.text}</label>
                        </div>
                        <button class="delete-task-btn" data-index="${index}">&times;</button>
                    `;
                    UIElements.todoList.appendChild(li);
                });

                UIElements.sessionLogList.innerHTML = '';
                activeSession.sessionLog.forEach(log => {
                    const li = document.createElement('li');
                    li.className = 'session-log-entry';
                    if (log.type === 'work') {
                        const taskList = log.tasks.map(task => `<li>${task.text} <span class="task-status">(${task.completed ? 'Completed' : 'Worked On'})</span></li>`).join('');
                        li.innerHTML = `
                            <div class="log-header">WORK SESSION - ${formatDuration(log.duration)}</div>
                            <ul class="log-task-list">${taskList}</ul>
                        `;
                    } else if (log.type === 'overtime') {
                        li.innerHTML = `<div class="log-header overtime">OVERTIME - ${formatDuration(log.duration)}</div>`;
                    }
                    UIElements.sessionLogList.appendChild(li);
                });

                if(activeSession.totalBreakDuration > 0) {
                    const li = document.createElement('li');
                    li.className = 'session-log-entry';
                    li.innerHTML = `<div class="log-header break">TOTAL BREAK - ${formatDuration(activeSession.totalBreakDuration)}</div>`;
                    UIElements.sessionLogList.appendChild(li);
                }

                if (activeSession.sidequestTime > 0) {
                     const li = document.createElement('li');
                     li.className = 'session-log-entry';
                     li.innerHTML = `<div class="log-header sidequest">SIDEQUEST - ${formatDuration(activeSession.sidequestTime)}</div>`;
                     UIElements.sessionLogList.appendChild(li);
                }
                if (activeSession.personalTime > 0) {
                     const li = document.createElement('li');
                     li.className = 'session-log-entry';
                     li.innerHTML = `<div class="log-header personal">PERSONAL - ${formatDuration(activeSession.personalTime)}</div>`;
                     UIElements.sessionLogList.appendChild(li);
                }
                
                UIElements.activeSessionDisplay.textContent = `Active Session: ${activeSession.name}`;
                UIElements.activeSessionDisplay.classList.remove('hidden');
            },
            renderSessionList: function() {
                UIElements.sessionList.innerHTML = '';
                Object.keys(AppState.sessions).forEach(sessionId => {
                    const session = AppState.sessions[sessionId];
                    const item = document.createElement('div');
                    item.className = `session-list-item ${sessionId === AppState.activeSessionId ? 'active' : ''}`;
                    item.textContent = session.name;
                    item.dataset.sessionId = sessionId;
                    item.onclick = () => SessionManager.switchSession(sessionId);
                    UIElements.sessionList.appendChild(item);
                });
            }
        };
        
        const SessionManager = {
             initialize: function() {
                AppState.sessions = Storage.get('sessions', {});
                AppState.activeSessionId = Storage.get('activeSessionId', null);

                if (Object.keys(AppState.sessions).length === 0) {
                    this.createSession('Default Session', false);
                } else if (!AppState.sessions[AppState.activeSessionId]) {
                    AppState.activeSessionId = Object.keys(AppState.sessions)[0];
                    Storage.save('activeSessionId', AppState.activeSessionId);
                }
                
                UI.renderActiveSessionData();
            },
            createSession: function(name, shouldSwitch = true) {
                if (!name || !name.trim()) return;
                const newSessionId = `session_${Date.now()}`;
                AppState.sessions[newSessionId] = {
                    id: newSessionId,
                    name: name.trim(),
                    todoTasks: [],
                    sessionLog: [],
                    sidequestTime: 0,
                    personalTime: 0,
                    totalBreakDuration: 0,
                    createdAt: Date.now()
                };
                if (shouldSwitch) {
                   this.switchSession(newSessionId);
                }
                UIElements.sessionNameInput.value = '';
                Storage.save('sessions', AppState.sessions);
            },
            switchSession: function(sessionId) {
                if (!sessionId || !AppState.sessions[sessionId]) return;
                Timer.resetAll();
                AppState.activeSessionId = sessionId;
                Storage.save('activeSessionId', AppState.activeSessionId);
                UI.renderActiveSessionData();
                UI.renderSessionList();
                UIElements.sessionManagementOverlay.classList.remove('visible');
            },
            endSession: function() {
                if (!AppState.activeSessionId) return;
                UIElements.exportSessionOverlay.classList.add('visible');
            },
            confirmEndSession: function(exportAction = null) {
                if (!AppState.activeSessionId) return;
                
                if (exportAction === 'txt') {
                    const logString = this.getSessionLogAsString();
                    const blob = new Blob([logString], { type: 'text/plain' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `session-log-${AppState.sessions[AppState.activeSessionId].name.replace(/\s+/g, '_')}-${Date.now()}.txt`;
                    a.click();
                    URL.revokeObjectURL(a.href);
                } else if (exportAction === 'notepad') {
                    const logString = this.getSessionLogAsString();
                    const currentNotepadContent = UIElements.notepadTextarea.value;
                    UIElements.notepadTextarea.value = currentNotepadContent ? `${currentNotepadContent}\n\n---\n\n${logString}` : logString;
                    Notepad.saveNote();
                }

                delete AppState.sessions[AppState.activeSessionId];
                
                const remainingIds = Object.keys(AppState.sessions);
                if (remainingIds.length > 0) {
                    this.switchSession(remainingIds[0]);
                } else {
                    this.createSession('Default Session');
                }
                
                Storage.save('sessions', AppState.sessions);
                UIElements.exportSessionOverlay.classList.remove('visible');
            },
            getSessionLogAsString: function() {
                 if (!AppState.activeSessionId) return "";
                 const session = AppState.sessions[AppState.activeSessionId];
                 let logString = `Session Log: ${session.name}\nStarted: ${new Date(session.createdAt).toLocaleString()}\nEnded: ${new Date().toLocaleString()}\n\n`;
                 let totalWorkDuration = 0;
                 
                 logString += "--- ACTIVITY LOG ---\n";
                 session.sessionLog.forEach(log => {
                     if (log.type === 'work' || log.type === 'overtime') {
                        if (log.type === 'work') {
                            logString += `WORK SESSION (${formatDuration(log.duration)}):\n`;
                            log.tasks.forEach(task => {
                                logString += `  - ${task.text} (${task.completed ? 'Completed' : 'Worked On'})\n`;
                            });
                        } else {
                             logString += `OVERTIME (${formatDuration(log.duration)})\n`;
                        }
                        totalWorkDuration += log.duration;
                     }
                 });

                if (session.totalBreakDuration > 0) {
                     logString += `\nTOTAL BREAK TIME: ${formatDuration(session.totalBreakDuration)}\n`;
                }

                 logString += `\nTotal Work Time: ${formatDuration(totalWorkDuration)}\n`;

                 if (UIElements.includeSidequestTime.checked && session.sidequestTime > 0) {
                    logString += `\n--- INTERRUPTIONS ---\n`;
                    logString += `Total Sidequest Time: ${formatDuration(session.sidequestTime)}\n`;
                 }
                  if (UIElements.includePersonalTime.checked && session.personalTime > 0) {
                    logString += `\n--- PERSONAL BREAKS ---\n`;
                    logString += `Total Personal Time: ${formatDuration(session.personalTime)}\n`;
                 }
                 return logString;
            }
        };

        const Tracker = {
            togglePanel: function(isActive) {
                const isPanelVisible = UIElements.softTrackingPanel.classList.toggle('visible', isActive);
                UIElements.appWrapper.classList.toggle('is-panel-open', isPanelVisible || UIElements.notepadPanel.classList.contains('visible'));
                UIElements.specialPauseControls.classList.toggle('hidden', !isActive);
                UIElements.optionsBtn.classList.toggle('hidden', !isActive);
                UIElements.resetBtn.classList.toggle('hidden', isActive);
            },
            showTaskModal: function(view) {
                if (!AppState.activeSessionId) return;
                UIElements.taskModalOverlay.classList.add('visible');

                if (view === 'new') {
                    UIElements.taskModalNewTaskView.classList.remove('hidden');
                    UIElements.taskModalEndSessionView.classList.add('hidden');
                    UIElements.taskModalInput.value = '';
                    UIElements.taskModalList.innerHTML = '';
                    const activeSession = AppState.sessions[AppState.activeSessionId];
                    if (activeSession) {
                        activeSession.todoTasks.filter(t => !t.completed).forEach(task => {
                            const item = document.createElement('div');
                            item.className = 'task-modal-item';
                            item.textContent = task.text;
                            item.onclick = () => { UIElements.taskModalInput.value = task.text; };
                            UIElements.taskModalList.appendChild(item);
                        });
                    }
                } else { // 'end' view
                    UIElements.taskModalNewTaskView.classList.add('hidden');
                    UIElements.taskModalEndSessionView.classList.remove('hidden');
                    UIElements.taskModalEndSessionList.innerHTML = '';
                    
                    const activeSession = AppState.sessions[AppState.activeSessionId];
                    const tasksForReview = activeSession ? activeSession.todoTasks : [];

                    if (tasksForReview.length === 0) {
                         const item = document.createElement('div');
                         item.className = 'end-session-item';
                         item.innerHTML = `<span>No tasks to log for this session.</span>`;
                         UIElements.taskModalEndSessionList.appendChild(item);
                    } else {
                        tasksForReview.forEach(task => {
                            const item = document.createElement('div');
                            item.className = 'end-session-item';
                            const isChecked = (task.text === AppState.currentTask) || AppState.newlyCompletedTasks.has(task.text);
                            item.innerHTML = `<input type="checkbox" id="end-session-${task.text.replace(/\s+/g, '-')}" data-task-text="${task.text}" ${isChecked ? 'checked' : ''}><label for="end-session-${task.text.replace(/\s+/g, '-')}">${task.text}</label>`;
                            UIElements.taskModalEndSessionList.appendChild(item);
                        });
                    }
                }
            },
            hideTaskModal: function() { UIElements.taskModalOverlay.classList.remove('visible'); },
            startSession: function() {
                const taskText = UIElements.taskModalInput.value.trim();
                if (!taskText) return;
                
                const activeSession = AppState.sessions[AppState.activeSessionId];
                if (activeSession && !activeSession.todoTasks.some(t => t.text === taskText)) {
                    activeSession.todoTasks.push({ text: taskText, completed: false });
                    Storage.save('sessions', AppState.sessions);
                    UI.renderActiveSessionData();
                }

                AppState.currentTask = taskText;
                AppState.newlyCompletedTasks.clear();
                this.hideTaskModal();
                Timer.startWork();
            },
            logSessionAndFinish: function() {
                const activeSession = AppState.sessions[AppState.activeSessionId];
                if (!activeSession) {
                    Timer.resetAll();
                    return;
                }
                
                const wasCutShort = AppState.timerPhase === 'LOGGING_EARLY';
                if (wasCutShort) {
                    const elapsed = AppState.totalDuration - AppState.timeLeft;
                    if (AppState.preLogPhase.includes('BREAK')) {
                        activeSession.totalBreakDuration = (activeSession.totalBreakDuration || 0) + elapsed;
                    } else if (AppState.preLogPhase === 'WORK_OVERTIME') {
                        AppState.overtimeDuration += elapsed;
                    } else {
                        AppState.completedWorkDuration = elapsed;
                    }
                }

                const tasksInModal = UIElements.taskModalEndSessionList.querySelectorAll('.end-session-item input');
                const loggedTasks = Array.from(tasksInModal).map(cb => ({
                    text: cb.dataset.taskText,
                    completed: cb.checked
                }));

                // Log the main work session
                if (AppState.completedWorkDuration > 0) {
                    const tasksToLog = loggedTasks.length > 0 ? loggedTasks.filter(t => t.completed) : (AppState.currentTask ? [{text: AppState.currentTask, completed: false}] : []);
                    activeSession.sessionLog.push({
                        type: 'work',
                        duration: AppState.completedWorkDuration,
                        tasks: tasksToLog,
                    });
                }
                
                // Log any overtime
                if (AppState.overtimeDuration > 0) {
                    activeSession.sessionLog.push({
                        type: 'overtime',
                        duration: AppState.overtimeDuration,
                        tasks: []
                    });
                }
                
                if (AppState.timerPhase === 'BREAK_FINISHED') {
                    const breakTime = parseInt(UIElements.breakTimeInput.value, 10) * 60;
                    activeSession.totalBreakDuration = (activeSession.totalBreakDuration || 0) + breakTime;
                }

                // Remove completed tasks from the main to-do list
                const completedTaskTexts = loggedTasks.filter(task => task.completed).map(task => task.text);
                if (completedTaskTexts.length > 0) {
                    activeSession.todoTasks = activeSession.todoTasks.filter(task => !completedTaskTexts.includes(task.text));
                }

                UI.renderActiveSessionData();
                Storage.save('sessions', AppState.sessions);
                
                this.hideTaskModal();
                Timer.resetAll();
            },
            showAddTaskPrompt: function() { UIElements.addTaskPromptOverlay.classList.add('visible'); UIElements.addTaskPromptInput.focus(); },
            hideAddTaskPrompt: function() { UIElements.addTaskPromptOverlay.classList.remove('visible'); UIElements.addTaskPromptInput.value = ''; },
            confirmAddTask: function() {
                if (!AppState.activeSessionId) return;
                const text = UIElements.addTaskPromptInput.value.trim();
                if(text) {
                    const activeSession = AppState.sessions[AppState.activeSessionId];
                    if (!activeSession.todoTasks.some(task => task.text === text)) {
                        activeSession.todoTasks.push({text: text, completed: false});
                    }
                    if (AppState.timerPhase !== 'IDLE') {
                        AppState.newlyCompletedTasks.add(text);
                    }
                    
                    Storage.save('sessions', AppState.sessions);
                    UI.renderActiveSessionData();
                    this.hideAddTaskPrompt();
                }
            },
            deleteTask: function(index) {
                if (!AppState.activeSessionId) return;
                const activeSession = AppState.sessions[AppState.activeSessionId];
                activeSession.todoTasks.splice(index, 1);
                Storage.save('sessions', AppState.sessions);
                UI.renderActiveSessionData();
            }
        };

        const Timer = {
            resetAll: function() {
                clearInterval(AppState.mainTimerId); 
                clearTimeout(AppState.workFinishedTimeoutId);
                AppState.mainTimerId = null;
                AppState.workFinishedTimeoutId = null;
                AppState.timerPhase = 'IDLE';
                const workTime = (parseInt(UIElements.workTimeInput.value, 10) || 25) * 60;
                AppState.timeLeft = workTime;
                AppState.totalDuration = workTime;
                AppState.overtimeDuration = 0;
                AppState.completedWorkDuration = 0;
                AppState.currentTask = null;
                AppState.preLogPhase = null;

                this.stopSpecialPause(false, false); 
                UIElements.startStopBtn.textContent = 'Start';
                UIElements.modeDisplay.textContent = 'Work';
                UIElements.inlineControls.classList.add('hidden');
                UI.updateTimerDisplay(AppState.timeLeft, AppState.totalDuration);
            },
            
            tick: function() {
                if (AppState.timerPhase.includes('PAUSED')) return;
                
                AppState.timeLeft -= 1;

                if (AppState.timeLeft <= 0) {
                    this.handlePhaseEnd();
                } else {
                    UI.updateTimerDisplay(AppState.timeLeft, AppState.totalDuration);
                }
            },

            handlePhaseEnd: function() {
                 clearInterval(AppState.mainTimerId);
                 AppState.mainTimerId = null;
                 Audio.playSound(AppState.timerPhase.includes('WORK') || AppState.timerPhase.includes('OVERTIME') ? 523.25 : 783.99);

                 switch(AppState.timerPhase) {
                    case 'WORK_RUNNING':
                        AppState.timerPhase = 'WORK_FINISHED';
                        AppState.completedWorkDuration = AppState.totalDuration;
                        UIElements.modeDisplay.textContent = 'Finished';
                        UIElements.startStopBtn.textContent = 'Log';
                        UIElements.inlineControls.classList.remove('hidden');
                        UIElements.extendTimeBtn.classList.remove('hidden');
                        UIElements.startBreakBtn.classList.remove('hidden');
                        AppState.workFinishedTimeoutId = setTimeout(() => this.startBreak(), 10000);
                        break;
                    case 'WORK_OVERTIME':
                        AppState.overtimeDuration += AppState.totalDuration;
                        AppState.timerPhase = 'WORK_FINISHED';
                        UIElements.modeDisplay.textContent = 'Finished';
                        UIElements.startStopBtn.textContent = 'Log';
                        UIElements.inlineControls.classList.remove('hidden');
                        UIElements.extendTimeBtn.classList.remove('hidden');
                        UIElements.startBreakBtn.classList.remove('hidden');
                        AppState.workFinishedTimeoutId = setTimeout(() => this.startBreak(), 10000);
                        break;
                    case 'BREAK_RUNNING':
                        AppState.timerPhase = 'BREAK_FINISHED';
                        UIElements.modeDisplay.textContent = 'Break Over';
                        UIElements.startStopBtn.textContent = 'Log';
                        if (AppState.isSoftTrackingActive) {
                            Tracker.showTaskModal('end');
                        } else {
                            this.resetAll();
                        }
                        break;
                 }
                 UI.updateTimerDisplay(0, AppState.totalDuration);
            },
            
            startWork: function() {
                const workTime = parseInt(UIElements.workTimeInput.value, 10) * 60;
                AppState.timerPhase = 'WORK_RUNNING';
                AppState.timeLeft = workTime;
                AppState.totalDuration = workTime;
                AppState.mainTimerId = setInterval(() => this.tick(), 1000);
                UIElements.modeDisplay.textContent = 'Work';
                UIElements.startStopBtn.textContent = 'Stop';
                UIElements.inlineControls.classList.add('hidden');
            },

            startBreak: function() {
                clearTimeout(AppState.workFinishedTimeoutId);

                if (AppState.timerPhase === 'WORK_OVERTIME') {
                    clearInterval(AppState.mainTimerId);
                    const elapsedOvertime = AppState.totalDuration - AppState.timeLeft;
                    AppState.overtimeDuration += elapsedOvertime;
                }

                const breakTime = parseInt(UIElements.breakTimeInput.value, 10) * 60;
                AppState.timerPhase = 'BREAK_RUNNING';
                AppState.timeLeft = breakTime;
                AppState.totalDuration = breakTime;
                AppState.mainTimerId = setInterval(() => this.tick(), 1000);
                UIElements.modeDisplay.textContent = 'Break';
                UIElements.startStopBtn.textContent = 'Stop';
                UIElements.inlineControls.classList.add('hidden');
            },
            
            addOvertime: function() {
                clearTimeout(AppState.workFinishedTimeoutId);
                const overtime = 300; // 5 minutes
                AppState.timerPhase = 'WORK_OVERTIME';
                AppState.timeLeft = overtime;
                AppState.totalDuration = overtime;
                AppState.mainTimerId = setInterval(() => this.tick(), 1000);
                UIElements.modeDisplay.textContent = 'Overtime';
                UIElements.startStopBtn.textContent = 'Stop';
                UIElements.inlineControls.classList.remove('hidden');
                UIElements.extendTimeBtn.classList.add('hidden');
                UIElements.startBreakBtn.classList.remove('hidden');
            },
            
            stopEarly: function() {
                clearInterval(AppState.mainTimerId);
                clearTimeout(AppState.workFinishedTimeoutId);
                AppState.mainTimerId = null;

                AppState.preLogPhase = AppState.timerPhase;
                AppState.timerPhase = 'LOGGING_EARLY';
                
                Tracker.showTaskModal('end');
            },
            
            startSpecialPause: function(mode) {
                if (!AppState.isSoftTrackingActive) return;
                // Cannot start special pause if timer isn't running
                if (!AppState.timerPhase.includes('RUNNING') && AppState.timerPhase !== 'WORK_OVERTIME') return;
                
                const now = Date.now();
                
                if (AppState.specialPause.mode && AppState.specialPause.mode !== mode) {
                    this.stopSpecialPause(true, false);
                } else if (AppState.specialPause.mode === mode) {
                    return; 
                }
                
                // Pause the main timer
                clearInterval(AppState.mainTimerId);
                clearTimeout(AppState.workFinishedTimeoutId);
                AppState.mainTimerId = null;
                UIElements.startStopBtn.textContent = 'Resume';
                
                AppState.specialPause.mode = mode;
                AppState.specialPause.currentModeStartTime = now;
                UIElements.modeDisplay.textContent = mode.toUpperCase();
                
                if (!AppState.specialPause.timerId) {
                    AppState.specialPause.timerId = setInterval(this.specialPauseTick.bind(this), 1000);
                }
                this.specialPauseTick();
            },
            stopSpecialPause: function(shouldSave = true, resumeMain = true) {
                if (!AppState.specialPause.mode) return;

                clearInterval(AppState.specialPause.timerId);
                AppState.specialPause.timerId = null;

                const elapsed = Math.round((Date.now() - AppState.specialPause.currentModeStartTime) / 1000);
                
                if (shouldSave && AppState.activeSessionId) {
                    const activeSession = AppState.sessions[AppState.activeSessionId];
                    if (AppState.specialPause.mode === 'sidequest') {
                        activeSession.sidequestTime = (activeSession.sidequestTime || 0) + elapsed;
                    } else if (AppState.specialPause.mode === 'personal') {
                        activeSession.personalTime = (activeSession.personalTime || 0) + elapsed;
                    }
                    Storage.save('sessions', AppState.sessions);
                    UI.renderActiveSessionData();
                }
                
                if (!resumeMain) return;

                AppState.specialPause.mode = null;
                AppState.specialPause.currentModeStartTime = null;
                
                // Resume the main timer
                UIElements.startStopBtn.textContent = 'Stop';
                UIElements.modeDisplay.textContent = AppState.timerPhase.replace('_PAUSED', '').replace('_RUNNING', '').replace('_', ' ');
                AppState.mainTimerId = setInterval(() => this.tick(), 1000);
            },
            specialPauseTick: function() {
                const elapsed = Math.floor((Date.now() - AppState.specialPause.currentModeStartTime) / 1000);
                UI.updateTimerDisplay(elapsed, 1);
            }
        };

        const Notepad = {
            init: function() { this.loadNote();
                UIElements.copyNotesBtn.addEventListener('click', this.copyNote.bind(this));
                UIElements.clearNotesBtn.addEventListener('click', this.clearNote.bind(this));
            },
            saveNote: function() { Storage.save('notepadContent', UIElements.notepadTextarea.value); },
            loadNote: function() { UIElements.notepadTextarea.value = Storage.get('notepadContent', ''); },
            copyNote: function() {
                if (UIElements.notepadTextarea.value) {
                    UIElements.notepadTextarea.select(); UIElements.notepadTextarea.setSelectionRange(0, 99999); 
                    try { document.execCommand('copy'); UIElements.copyNotesBtn.textContent = 'Copied!';
                        setTimeout(() => { UIElements.copyNotesBtn.textContent = 'Copy'; }, 1500);
                    } catch (err) { console.error('Fallback: Oops, unable to copy', err); }
                    window.getSelection().removeAllRanges();
                }
            },
            clearNote: function() { UIElements.notepadTextarea.value = ''; this.saveNote(); }
        };

        function setupEventListeners() {
            UIElements.menuIcon.addEventListener('click', () => UIElements.leftIconMenu.classList.toggle('menu-open'));
            UIElements.bellIcon.addEventListener('click', () => {
                AppState.isSoundEnabled = !AppState.isSoundEnabled;
                UIElements.bellIcon.src = AppState.isSoundEnabled ? AppState.bellEnabledSrc : AppState.bellDisabledSrc;
                Storage.save('soundEnabled', AppState.isSoundEnabled);
            });
            
            UIElements.notepadIcon.addEventListener('click', () => {
                const isNotepadVisible = UIElements.notepadPanel.classList.toggle('visible');
                const isTrackingVisible = UIElements.softTrackingPanel.classList.contains('visible');
                UIElements.appWrapper.classList.toggle('is-panel-open', isNotepadVisible || isTrackingVisible);
                UIElements.timerOptionsWrapper.classList.toggle('hidden', isNotepadVisible);
            });

            UIElements.gpsIcon.addEventListener('click', () => {
                AppState.isSoftTrackingActive = !AppState.isSoftTrackingActive;
                Timer.resetAll(); 
                const isTrackingVisible = AppState.isSoftTrackingActive;
                Tracker.togglePanel(isTrackingVisible);
                UIElements.activeSessionDisplay.classList.toggle('hidden', !isTrackingVisible);
                const isNotepadVisible = UIElements.notepadPanel.classList.contains('visible');
                UIElements.appWrapper.classList.toggle('is-panel-open', isNotepadVisible || isTrackingVisible);
                UIElements.timerOptionsWrapper.classList.toggle('hidden', isNotepadVisible);

                const originalText = 'Work';
                const statusText = 'SOFT TRACKING';
                UIElements.modeDisplay.classList.remove('tracking-activated-animation', 'tracking-deactivated-animation');
                void UIElements.modeDisplay.offsetWidth;
                UIElements.modeDisplay.textContent = statusText;
                UIElements.modeDisplay.classList.add(AppState.isSoftTrackingActive ? 'tracking-activated-animation' : 'tracking-deactivated-animation');
                setTimeout(() => {
                    UIElements.modeDisplay.classList.remove('tracking-activated-animation', 'tracking-deactivated-animation');
                    UIElements.modeDisplay.textContent = originalText;
                }, 2500);
            });

            UIElements.startStopBtn.addEventListener('click', () => {
                Audio.initContext();

                if (AppState.specialPause.mode) {
                    Timer.stopSpecialPause(true, true);
                    return;
                }

                if (AppState.timerPhase === 'IDLE') {
                    if (AppState.isSoftTrackingActive) {
                        Tracker.showTaskModal('new');
                    } else {
                        Timer.startWork();
                    }
                } else if (AppState.timerPhase.includes('RUNNING') || AppState.timerPhase === 'WORK_OVERTIME') {
                     Timer.stopEarly();
                } else if (AppState.timerPhase === 'WORK_FINISHED' || AppState.timerPhase === 'BREAK_FINISHED') {
                    clearTimeout(AppState.workFinishedTimeoutId);
                    Tracker.showTaskModal('end');
                }
            });
            
            UIElements.optionsBtn.addEventListener('click', () => {
                UI.renderSessionList();
                UIElements.sessionManagementOverlay.classList.add('visible');
            });
            
            UIElements.resetBtn.addEventListener('click', () => Timer.resetAll());
            
            UIElements.sidequestBtn.addEventListener('click', () => Timer.startSpecialPause('sidequest'));
            UIElements.personalBtn.addEventListener('click', () => Timer.startSpecialPause('personal'));

            document.querySelectorAll('#pomodoro-settings .setting-item.label').forEach(el => {
                el.addEventListener('click', () => { if (AppState.timerPhase === 'IDLE') { AppState.initialMode = el.dataset.startMode; Timer.resetAll(); } });
            });

            [UIElements.workTimeInput, UIElements.breakTimeInput].forEach(input => {
                input.addEventListener('change', () => {
                    if(AppState.timerPhase === 'IDLE') { Timer.resetAll(); }
                    Storage.save('pomodoroWork', UIElements.workTimeInput.value);
                    Storage.save('pomodoroBreak', UIElements.breakTimeInput.value);
                });
            });
            
            UIElements.notepadTextarea.addEventListener('input', () => Notepad.saveNote());
            UIElements.logoContainer.addEventListener('click', () => UI.toggleDonateOverlay(true));
            document.getElementById('exit-labs-btn').addEventListener('click', () => { window.location.href = 'index.html'; });

            UIElements.closeModalBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                     const modal = e.target.closest('.modal-overlay');
                     modal.classList.remove('visible', 'active');
                     
                     if (modal.id === 'task-modal-overlay') {
                        if (AppState.timerPhase === 'LOGGING_EARLY') {
                            // User cancelled logging, so resume the previous session
                            AppState.timerPhase = AppState.preLogPhase;
                            AppState.preLogPhase = null;
                            AppState.mainTimerId = setInterval(() => Timer.tick(), 1000);
                        } else {
                            Timer.resetAll();
                        }
                     }
                });
            });
            
            UIElements.extendTimeBtn.addEventListener('click', () => Timer.addOvertime());
            UIElements.startBreakBtn.addEventListener('click', () => Timer.startBreak());

            UIElements.addTaskBtn.addEventListener('click', Tracker.showAddTaskPrompt);
            UIElements.addTaskPromptConfirmBtn.addEventListener('click', () => Tracker.confirmAddTask());
            UIElements.addTaskPromptInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') Tracker.confirmAddTask(); });

            UIElements.todoList.addEventListener('click', (e) => {
                const target = e.target;
                if (target.matches('.delete-task-btn')) {
                    const index = parseInt(target.dataset.index, 10);
                    Tracker.deleteTask(index);
                } else if (target.matches('input[type="checkbox"]')) {
                    if (!AppState.activeSessionId) return;
                    const index = parseInt(target.dataset.index, 10);
                    const task = AppState.sessions[AppState.activeSessionId].todoTasks[index];
                    if (task) {
                        task.completed = target.checked;
                        if (task.completed && AppState.isSoftTrackingActive) {
                           AppState.newlyCompletedTasks.add(task.text);
                        } else {
                           AppState.newlyCompletedTasks.delete(task.text);
                        }
                        UI.renderActiveSessionData(); 
                        Storage.save('sessions', AppState.sessions);
                    }
                }
            });
            UIElements.taskModalStartBtn.addEventListener('click', () => Tracker.startSession());
            UIElements.taskModalConfirmBtn.addEventListener('click', (e) => {
                Tracker.logSessionAndFinish();
            });
            
            // Session Management Listeners
            UIElements.createSessionBtn.addEventListener('click', () => SessionManager.createSession(UIElements.sessionNameInput.value));
            UIElements.endSessionBtn.addEventListener('click', () => SessionManager.endSession());
            UIElements.saveSessionTxtBtn.addEventListener('click', () => SessionManager.confirmEndSession('txt'));
            UIElements.copySessionToNotepadBtn.addEventListener('click', () => SessionManager.confirmEndSession('notepad'));
            UIElements.endSessionAnywayBtn.addEventListener('click', () => SessionManager.confirmEndSession(null));
        }

        function initializeApp() {
            UIElements.workTimeInput.value = Storage.get('pomodoroWork', 25);
            UIElements.breakTimeInput.value = Storage.get('pomodoroBreak', 5);
            AppState.isSoundEnabled = Storage.get('soundEnabled', true);
            UIElements.bellIcon.src = AppState.isSoundEnabled ? AppState.bellEnabledSrc : AppState.bellDisabledSrc;
            
            SessionManager.initialize();
            Notepad.init();
            setupEventListeners();
            Timer.resetAll();
        }

        initializeApp();
    });
    </script>
</body>
</html>
